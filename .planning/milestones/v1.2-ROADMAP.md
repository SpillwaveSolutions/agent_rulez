# Milestone v1.2: P2 Features

**Status:** âœ… SHIPPED 2026-02-07
**Phases:** 1-3
**Total Plans:** 6

## Overview

Enhanced the RuleZ policy engine with advanced injection and conditional rule features:
- `inject_inline` - Embed markdown context directly in YAML rules
- `inject_command` - Generate context dynamically via shell commands
- `enabled_when` - Activate rules conditionally based on expressions

## Phases

### Phase 1: Inline Content Injection

**Goal**: Allow injecting markdown content directly in rules without separate files.
**Depends on**: None
**Plans**: 1 plan

Plans:
- [x] 01-01: Add inject_inline field and tests

**Details:**
- Added `inject_inline: Option<String>` to Actions struct
- Handles in both normal and warn mode
- inject_inline takes precedence over inject when both specified
- 5 unit tests + 2 integration tests

### Phase 2: Command-Based Context Generation

**Goal**: Generate context dynamically by running a shell command.
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: Add inject_command field and execute_inject_command function
- [x] 02-02: Add integration tests for inject_command

**Details:**
- Added `inject_command: Option<String>` to Actions struct
- Implemented `execute_inject_command` async function with timeout and error handling
- Execution order: inject_inline > inject_command > inject > run
- 3 unit tests + 3 integration tests

### Phase 3: Conditional Rule Activation

**Goal**: Rules that only activate under certain conditions.
**Depends on**: Phase 2
**Plans**: 3 plans

Plans:
- [x] 03-01: Add evalexpr dependency and enabled_when field
- [x] 03-02: Implement build_eval_context and is_rule_enabled
- [x] 03-03: Add validation and integration tests

**Details:**
- Added `enabled_when: Option<String>` to Rule struct
- Added evalexpr 13.1 for expression evaluation
- Implemented build_eval_context() with env_*, tool_name, event_type
- Implemented is_rule_enabled() with fail-closed semantics
- Added validation in Config.validate() using build_operator_tree
- 8 unit tests + 5 integration tests

---

## Milestone Summary

**Key Decisions:**
- evalexpr 13.1 for expression evaluation (lightweight, no deps)
- Underscore syntax for variable names (env_CI, not env.CI)
- Fail-closed semantics for invalid expressions
- Execution precedence: inject_inline > inject_command > inject > run

**Issues Resolved:**
- Missing inject_command: None in 9 test instantiations
- evalexpr type annotations (DefaultNumericTypes)
- Expression validation using build_operator_tree

**Technical Debt Incurred:**
- None identified

---

*For current project status, see .planning/ROADMAP.md*
