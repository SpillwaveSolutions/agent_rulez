---
phase: 10-tauri-ci-integration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - .github/workflows/tauri-build.yml
autonomous: true

must_haves:
  truths:
    - "Pushing to main, develop, or release/** branches with rulez-ui/ changes triggers the tauri-build workflow"
    - "E2E tests run FIRST in web mode (Playwright against Vite dev server) before any Tauri builds start"
    - "Tauri build jobs have `needs: test-e2e` so they only start if E2E tests pass (fail-fast pattern)"
    - "Linux build uses explicit ubuntu-22.04 runner (NOT ubuntu-latest) with libwebkit2gtk-4.1-dev (NOT 4.0)"
    - "Build matrix includes ubuntu-22.04, macos-latest, and windows-latest"
    - "Matrix uses fail-fast: false so all platform builds complete even if one fails"
    - "Rust build artifacts are cached via swatinem/rust-cache with workspaces pointing to rulez-ui/src-tauri"
    - "Build artifacts (.dmg, .msi, .AppImage) are uploaded for release branches via tauri-action"
    - "workflow_dispatch allows manual triggering for debugging"
  artifacts:
    - path: ".github/workflows/tauri-build.yml"
      provides: "Complete Tauri CI build workflow with E2E gate and multi-platform matrix"
      contains: "tauri-apps/tauri-action"
  key_links:
    - from: ".github/workflows/tauri-build.yml"
      to: "rulez-ui/"
      via: "Path triggers, working-directory, and projectPath all reference rulez-ui"
      pattern: "rulez-ui"
    - from: ".github/workflows/tauri-build.yml"
      to: "rulez-ui/src-tauri/"
      via: "swatinem/rust-cache workspaces parameter"
      pattern: "rulez-ui/src-tauri"
---

<objective>
Create .github/workflows/tauri-build.yml with a two-job pipeline: (1) fast E2E tests in web mode, (2) multi-platform Tauri builds gated on E2E success.

Purpose: Automate cross-platform desktop app builds for all three platforms (Linux, macOS, Windows) with fail-fast feedback from E2E tests. The E2E tests run in 2-3 minutes in web mode, preventing expensive 8-15 minute multi-platform builds when the UI is broken.
Output: New tauri-build.yml workflow file.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tauri-ci-integration/10-RESEARCH.md

Key files to read before implementing:
@.github/workflows/ci.yml — Existing CI workflow for style reference (job structure, caching)
@.github/workflows/e2e.yml — Existing E2E workflow for Playwright step reference
@rulez-ui/package.json — Frontend dependencies and scripts (bun run dev, bun run build)
@rulez-ui/playwright.config.ts — Playwright config (baseURL, browsers, webServer)
@rulez-ui/src-tauri/tauri.conf.json — Tauri config (build commands, bundle targets)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tauri-build.yml with E2E test job</name>
  <files>.github/workflows/tauri-build.yml</files>
  <action>
Create `.github/workflows/tauri-build.yml` with the following structure.

**Workflow trigger configuration:**

```yaml
name: Tauri CI Build

on:
  push:
    branches: [main, develop, 'release/**']
    paths:
      - 'rulez-ui/**'
      - '.github/workflows/tauri-build.yml'
  pull_request:
    paths:
      - 'rulez-ui/**'
  workflow_dispatch:
```

**Job 1: test-e2e (E2E Tests in Web Mode)**

This job runs fast Playwright tests against the Vite dev server (not full Tauri app).

```yaml
jobs:
  test-e2e:
    name: E2E Tests (Web Mode)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: rulez-ui

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium webkit

      - name: Run E2E tests
        run: bunx playwright test
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: rulez-ui/playwright-report/
          retention-days: 30
```

**Job 2: build-tauri (Multi-Platform Builds)**

This job depends on test-e2e passing. It builds the Tauri desktop app on all three platforms.

Key design decisions:
- `needs: test-e2e` enforces E2E-first ordering
- `fail-fast: false` allows all platforms to complete
- `ubuntu-22.04` is used explicitly (NOT ubuntu-latest)
- `libwebkit2gtk-4.1-dev` is installed (NOT 4.0) — required by Tauri 2.0
- `swatinem/rust-cache` points to `rulez-ui/src-tauri -> target`
- `tauri-apps/tauri-action@v0` handles the build and optionally uploads artifacts
- For tag pushes (v*), configure `tagName`, `releaseName`, and `releaseBody` to auto-create GitHub releases

```yaml
  build-tauri:
    name: Build Tauri (${{ matrix.platform }})
    needs: test-e2e
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-22.04, macos-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies (Tauri 2.0)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: rulez-ui/src-tauri -> target

      - name: Install frontend dependencies
        run: bun install
        working-directory: rulez-ui

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: rulez-ui
          tagName: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '' }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/v') && format('RuleZ UI {0}', github.ref_name) || '' }}
          releaseBody: ${{ startsWith(github.ref, 'refs/tags/v') && 'See CHANGELOG.md for details.' || '' }}
          releaseDraft: false
          prerelease: false
```

**Important implementation notes:**

1. The `tagName`, `releaseName`, and `releaseBody` fields use conditional expressions. When the ref is a version tag (v*), tauri-action auto-creates a GitHub release with the built artifacts. For non-tag pushes (PRs, branch pushes), these fields are empty strings and tauri-action just verifies the build succeeds without creating a release.

2. The Linux dependency list matches the Tauri v2 prerequisites documentation exactly. The critical package is `libwebkit2gtk-4.1-dev` (NOT 4.0).

3. The `permissions: contents: write` is needed at the workflow level for tauri-action to create GitHub releases on tag pushes.

4. Add a top-of-file comment explaining the two-job architecture:
```yaml
# Tauri CI Build for RuleZ UI
#
# Two-job pipeline:
# 1. E2E Tests (Web Mode) — Fast Playwright tests (~2-3 min)
# 2. Tauri Build (Multi-Platform) — Cross-platform desktop builds (~8-15 min)
#
# The Tauri build only starts if E2E tests pass (fail-fast pattern).
# Linux uses explicit ubuntu-22.04 with libwebkit2gtk-4.1-dev (Tauri 2.0 requirement).
#
# Release artifacts (.dmg, .msi, .AppImage) are auto-uploaded when triggered by version tags (v*).
```

5. Add `permissions: contents: write` at the workflow level (needed for release creation).
  </action>
  <verify>
Validate YAML syntax:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/tauri-build.yml'))"
```

Verify key patterns are present:
```bash
grep "needs: test-e2e" .github/workflows/tauri-build.yml
grep "ubuntu-22.04" .github/workflows/tauri-build.yml
grep "libwebkit2gtk-4.1-dev" .github/workflows/tauri-build.yml
grep "fail-fast: false" .github/workflows/tauri-build.yml
grep "tauri-apps/tauri-action" .github/workflows/tauri-build.yml
grep "swatinem/rust-cache" .github/workflows/tauri-build.yml
grep "rulez-ui" .github/workflows/tauri-build.yml
```

Verify NO occurrences of anti-patterns:
```bash
grep "rulez_ui" .github/workflows/tauri-build.yml    # Should return nothing
grep "webkit2gtk-4.0" .github/workflows/tauri-build.yml  # Should return nothing
grep "ubuntu-latest" .github/workflows/tauri-build.yml | grep -v "test-e2e"  # Build job should NOT use ubuntu-latest
```
  </verify>
  <done>
- tauri-build.yml created with two-job pipeline
- test-e2e job runs Playwright in web mode (ubuntu-latest is fine for E2E since no webkit needed)
- build-tauri job depends on test-e2e via `needs:`
- Linux build uses explicit ubuntu-22.04 with libwebkit2gtk-4.1-dev
- Matrix includes ubuntu-22.04, macos-latest, windows-latest with fail-fast: false
- Rust cache configured for rulez-ui/src-tauri workspace
- tauri-action@v0 handles builds and auto-releases on version tags
- workflow_dispatch enabled for manual triggers
- permissions: contents: write set for release creation
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/tauri-build.yml` exists and is valid YAML
2. `grep "needs: test-e2e"` confirms build depends on E2E success
3. `grep "ubuntu-22.04"` confirms explicit Linux runner version
4. `grep "libwebkit2gtk-4.1-dev"` confirms correct webkit version
5. `grep "fail-fast: false"` confirms matrix continues on individual failure
6. `grep "tauri-apps/tauri-action@v0"` confirms official action used
7. `grep "rulez_ui"` returns zero results (no directory mismatch)
8. `grep "webkit2gtk-4.0"` returns zero results (no wrong webkit version)
9. Workflow has `permissions: contents: write` for release creation
10. `workflow_dispatch` trigger is present for manual runs
</verification>

<success_criteria>
- tauri-build.yml is valid YAML with correct structure
- E2E tests gate Tauri builds via `needs: test-e2e`
- Linux uses ubuntu-22.04 with libwebkit2gtk-4.1-dev
- All three platforms in matrix: ubuntu-22.04, macos-latest, windows-latest
- fail-fast: false allows all platforms to complete
- Rust cache targets rulez-ui/src-tauri workspace
- Release artifacts auto-uploaded on version tags via tauri-action
- No anti-patterns: no rulez_ui, no webkit2gtk-4.0, no ubuntu-latest for builds
</success_criteria>

<output>
After completion, create `.planning/phases/10-tauri-ci-integration/10-02-SUMMARY.md`
</output>
