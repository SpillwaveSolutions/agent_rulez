---
phase: 01-inline-content-injection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rulez/src/models.rs
  - rulez/src/hooks.rs
  - rulez/tests/oq_us2_injection.rs
autonomous: true

must_haves:
  truths:
    - "YAML rules with inject_inline field parse successfully"
    - "Inline content is injected into response context"
    - "inject_inline takes precedence over inject when both specified"
    - "Multiline YAML strings (| and >) work correctly"
    - "Warn mode handles inject_inline identically to inject"
  artifacts:
    - path: "rulez/src/models.rs"
      provides: "Actions.inject_inline field"
      contains: "inject_inline: Option<String>"
    - path: "rulez/src/hooks.rs"
      provides: "inject_inline handling in execute_rule_actions"
      contains: "inject_inline"
    - path: "rulez/tests/oq_us2_injection.rs"
      provides: "Tests for inject_inline functionality"
      contains: "inject_inline"
  key_links:
    - from: "rulez/src/hooks.rs"
      to: "rulez/src/models.rs"
      via: "Actions.inject_inline field access"
      pattern: "actions\\.inject_inline"
    - from: "rulez/src/models.rs (unit tests)"
      to: "serde_yaml parsing"
      via: "YAML multiline string deserialization"
      pattern: "serde_yaml::from_str.*inject_inline"
    - from: "rulez/tests/oq_us2_injection.rs"
      to: "rulez/src/models.rs"
      via: "Integration test validates full YAML parsing chain"
      pattern: "inject_inline:.*\\|"
---

<objective>
Implement the `inject_inline` action for the RuleZ rule engine.

Purpose: Allow users to embed markdown content directly in YAML rules without requiring separate context files. This simplifies single-file configurations and makes rule definitions more self-contained.

Output: Working inject_inline action with tests proving multiline YAML content injects into Claude's context correctly.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-inline-content-injection/01-RESEARCH.md
@rulez/src/models.rs
@rulez/src/hooks.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inject_inline field and handling</name>
  <files>
    rulez/src/models.rs
    rulez/src/hooks.rs
  </files>
  <action>
    In models.rs, add `inject_inline: Option<String>` to the Actions struct:
    - Location: Line 277-278, immediately AFTER the existing `inject` field
    - Add doc comment: `/// Inline markdown content to inject directly (no file read)`
    - Add serde attribute: `#[serde(skip_serializing_if = "Option::is_none")]`
    - Field declaration: `pub inject_inline: Option<String>,`

    In hooks.rs, modify execute_rule_actions():
    - Location: Insert at line 371, BEFORE the comment `// Handle context injection` and the `if let Some(ref inject_path) = actions.inject` block
    - Add inject_inline handling that takes precedence over inject:
      ```rust
      // Handle inline content injection (takes precedence over inject)
      if let Some(ref inline_content) = actions.inject_inline {
          return Ok(Response::inject(inline_content.clone()));
      }
      ```
    - No file I/O needed - content is already in memory from YAML parsing

    In hooks.rs, modify execute_rule_actions_warn_mode():
    - Location: Insert at line 595, BEFORE the comment `// Context injection still works in warn mode` and the `if let Some(ref inject_path) = actions.inject` block
    - Add identical inject_inline handling:
      ```rust
      // Handle inline content injection (takes precedence over inject)
      if let Some(ref inline_content) = actions.inject_inline {
          return Ok(Response::inject(inline_content.clone()));
      }
      ```
    - Warn mode treats inject_inline identically (no blocking behavior to convert)
  </action>
  <verify>
    cargo build --package rulez
    cargo test --package rulez -- models::governance_tests --nocapture
  </verify>
  <done>
    - models.rs has inject_inline field with proper serde attributes
    - hooks.rs handles inject_inline in both execute_rule_actions and execute_rule_actions_warn_mode
    - Code compiles without warnings
    - Existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inject_inline tests</name>
  <files>
    rulez/src/models.rs
    rulez/tests/oq_us2_injection.rs
  </files>
  <action>
    **Unit Tests in models.rs** - Add to existing `governance_tests` module (around line 800+):

    1. `test_inject_inline_literal_block` - YAML literal block style (|):
       - Tests that `|` preserves newlines in multiline content
       - YAML input:
         ```yaml
         inject_inline: |
           ## Production Warning
           You are editing production files.
           Be extra careful.
         ```
       - Assertions:
         - `actions.inject_inline.is_some()` - field parses successfully
         - `content.contains("## Production Warning")` - header preserved
         - `content.contains("\n")` - literal block preserves newlines

    2. `test_inject_inline_folded_block` - YAML folded block style (>):
       - Tests that `>` folds multiline into single line
       - YAML input:
         ```yaml
         inject_inline: >
           This is a long paragraph that
           will be folded into a single line.
         ```
       - Assertions:
         - `actions.inject_inline.is_some()` - field parses successfully
         - `content.contains("This is a long paragraph")` - content preserved

    3. `test_inject_inline_simple_string` - Quoted string style:
       - Tests simple quoted string parsing
       - YAML input: `inject_inline: "Single line warning"`
       - Assertions:
         - `actions.inject_inline.unwrap() == "Single line warning"` - exact match

    4. `test_inject_inline_precedence` - Verify inject_inline takes precedence:
       - YAML input with BOTH fields:
         ```yaml
         inject: "/path/to/file.md"
         inject_inline: "Inline takes precedence"
         ```
       - Assertions:
         - Both fields parse successfully
         - `actions.inject_inline.is_some()` and `actions.inject.is_some()`
         - (Runtime precedence tested via integration test)

    **Integration Test in tests/oq_us2_injection.rs**:

    5. `test_us2_inline_content_injection` - Full end-to-end test:
       - Setup: Create temp dir with .claude/hooks.yaml containing inject_inline rule
       - Config content:
         ```yaml
         version: "1.0"
         rules:
           - name: inline-warning
             matchers:
               directories: ["/prod/"]
             actions:
               inject_inline: |
                 ## Production Warning
                 You are editing production files.
         ```
       - Event: PreToolUse Edit event with filePath "/prod/config.yaml"
       - Execute: Run rulez binary with event on stdin
       - Assertions:
         - Exit code 0 (success)
         - stdout contains "continue" and "true" (or Response::allow pattern)
         - stdout contains "Production Warning" (inline content injected)
       - Evidence: Save test evidence to evidence_dir()
  </action>
  <verify>
    cargo test --package rulez -- test_inject_inline_literal_block --nocapture
    cargo test --package rulez -- test_inject_inline_folded_block --nocapture
    cargo test --package rulez -- test_inject_inline_simple_string --nocapture
    cargo test --package rulez -- test_inject_inline_precedence --nocapture
    cargo test --package rulez -- test_us2_inline_content_injection --nocapture
  </verify>
  <done>
    - test_inject_inline_literal_block passes (literal block YAML parsing verified)
    - test_inject_inline_folded_block passes (folded block YAML parsing verified)
    - test_inject_inline_simple_string passes (simple string YAML parsing verified)
    - test_inject_inline_precedence passes (both fields can coexist)
    - test_us2_inline_content_injection passes (end-to-end injection works)
    - All existing OQ-US2 tests still pass (no regressions)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   cargo build --package rulez
   ```

2. Run all tests:
   ```bash
   cargo test --package rulez
   ```

3. Manual verification (optional):
   Create a test config with inject_inline and run rulez debug with a matching event.
</verification>

<success_criteria>
- inject_inline field exists in Actions struct with proper serde attributes
- inject_inline handling in execute_rule_actions returns Response::inject with content
- inject_inline handling in execute_rule_actions_warn_mode works identically
- All 3+ new unit tests pass (literal, folded, simple string)
- Integration test proves end-to-end injection works
- All existing tests pass (no regressions)
- cargo clippy reports no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/01-inline-content-injection/01-01-SUMMARY.md`
</output>
