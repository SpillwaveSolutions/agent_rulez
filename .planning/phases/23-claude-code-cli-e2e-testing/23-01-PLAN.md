---
phase: 23-claude-code-cli-e2e-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/run.sh
  - e2e/lib/harness.sh
  - e2e/lib/reporting.sh
  - e2e/.gitignore
  - Taskfile.yml
autonomous: true

must_haves:
  truths:
    - "`task e2e` entry point exists and invokes `e2e/run.sh`"
    - "Harness creates isolated workspace directories under `e2e/.runs/<run-id>/`"
    - "Reporting generates JUnit XML, ASCII table, and Markdown summary from test results"
    - "`e2e/.runs/` is gitignored"
  artifacts:
    - path: "e2e/run.sh"
      provides: "Main E2E entry point that discovers and runs CLI scenario directories"
      min_lines: 50
    - path: "e2e/lib/harness.sh"
      provides: "Core harness functions: workspace setup, assertions, timing, log snapshot"
      min_lines: 80
    - path: "e2e/lib/reporting.sh"
      provides: "JUnit XML generation, ASCII table rendering, Markdown summary output"
      min_lines: 80
    - path: "e2e/.gitignore"
      provides: "Ignores .runs/ directory"
    - path: "Taskfile.yml"
      provides: "e2e task entry point"
      contains: "task e2e"
  key_links:
    - from: "Taskfile.yml"
      to: "e2e/run.sh"
      via: "task e2e invocation"
      pattern: "e2e/run\\.sh"
    - from: "e2e/run.sh"
      to: "e2e/lib/harness.sh"
      via: "source import"
      pattern: "source.*lib/harness\\.sh"
    - from: "e2e/run.sh"
      to: "e2e/lib/reporting.sh"
      via: "source import"
      pattern: "source.*lib/reporting\\.sh"
---

<objective>
Create the E2E test harness framework with workspace isolation, assertion helpers, multi-format reporting, and Taskfile integration.

Purpose: Establish the reusable foundation that all 5 CLI phases (23-27) will build upon. This plan creates the harness infrastructure without any CLI-specific code.
Output: `e2e/run.sh` entry point, `e2e/lib/harness.sh` core functions, `e2e/lib/reporting.sh` reporters, `task e2e` Taskfile entry.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-claude-code-cli-e2e-testing/23-RESEARCH.md
@Taskfile.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create harness core library and workspace isolation</name>
  <files>e2e/lib/harness.sh, e2e/.gitignore</files>
  <action>
Create `e2e/lib/harness.sh` as a sourceable bash library with these functions:

**Workspace management:**
- `harness_init()` — Sets global `E2E_ROOT` (script's parent dir), `RUN_ID` (date-based: `YYYYMMDD-HHMMSS`), `RUN_DIR` (`$E2E_ROOT/.runs/$RUN_ID`), `RULEZ_BINARY` (auto-detect from `$E2E_ROOT/../rulez/target/release/rulez` or `$E2E_ROOT/../rulez/target/debug/rulez`, error if neither exists). Sets `TOTAL_PASS=0`, `TOTAL_FAIL=0`, `TOTAL_SKIP=0`. Creates `$RUN_DIR`.
- `setup_workspace(cli_name, scenario_name)` — Creates `$RUN_DIR/$cli_name/$scenario_name/` with a `.claude/` subdirectory. Echoes the absolute workspace path. Records log line count snapshot (`wc -l ~/.claude/logs/rulez.log`) into `$WORKSPACE_LOG_SNAPSHOT` (global var).
- `cleanup_workspace(workspace, status)` — If `status=pass` and `E2E_KEEP_ALL` is not set, remove workspace. If `status=fail`, keep workspace for debugging. Print retained path on failure.

**Assertions:**
- `assert_file_exists(filepath, msg)` — Returns 0 if file exists, 1 otherwise. Prints PASS/FAIL with msg.
- `assert_file_contains(filepath, pattern, msg)` — Greps file for pattern. Returns 0/1. Prints PASS/FAIL.
- `assert_exit_code(actual, expected, msg)` — Compares integers. Returns 0/1. Prints PASS/FAIL.
- `assert_log_contains(pattern, msg)` — Reads new lines from `~/.claude/logs/rulez.log` since `$WORKSPACE_LOG_SNAPSHOT`. Greps for pattern. Returns 0/1. Prints PASS/FAIL.

**Timing:**
- `timer_start()` — Stores `$SECONDS` in `_TIMER_START`.
- `timer_elapsed()` — Echoes elapsed seconds since `timer_start`.

**Scenario runner:**
- `run_scenario(cli_name, scenario_name, scenario_func)` — Calls `setup_workspace`, runs `timer_start`, invokes `$scenario_func $workspace $RULEZ_BINARY`, captures exit code, records `timer_elapsed`, calls `record_result` (from reporting.sh), calls `cleanup_workspace`. Prints scenario status line.

Create `e2e/.gitignore` containing:
```
.runs/
```

Mark `e2e/lib/harness.sh` as `#!/usr/bin/env bash` with `set -euo pipefail`. All functions should use `local` for variables to avoid global namespace pollution (except the documented globals).
  </action>
  <verify>
`bash -n e2e/lib/harness.sh` exits 0 (no syntax errors).
`grep -q 'setup_workspace' e2e/lib/harness.sh` confirms function exists.
`grep -q 'assert_file_exists' e2e/lib/harness.sh` confirms assertion exists.
`cat e2e/.gitignore` shows `.runs/`.
  </verify>
  <done>
`e2e/lib/harness.sh` is a valid bash library with workspace isolation, assertions, timing, and scenario runner functions. `.gitignore` excludes `.runs/`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reporting library and main entry point</name>
  <files>e2e/lib/reporting.sh, e2e/run.sh, Taskfile.yml</files>
  <action>
**Create `e2e/lib/reporting.sh`** as a sourceable bash library with:

**Result tracking:**
- `reporting_init()` — Initializes `JUNIT_CASES_FILE` (mktemp), `JUNIT_TESTS=0`, `JUNIT_FAILURES=0`, `JUNIT_SKIPS=0`, declares associative array `RESULTS` for ASCII table.
- `record_result(cli_name, scenario_name, status, elapsed_secs, message)` — status is "pass", "fail", or "skip". Increments counters. Stores in `RESULTS["$cli_name:$scenario_name"]="$status"`. Appends JUnit XML testcase element to `$JUNIT_CASES_FILE`. For failures, include `<failure>` element with message. For skips, include `<skipped/>` element.

**JUnit XML output:**
- `write_junit_xml(output_path)` — Wraps collected testcases in `<testsuites><testsuite>` with name "RuleZ E2E", tests/failures/errors counts. Writes to `$output_path`. Removes temp file.

**ASCII table:**
- `print_results_table(cli_names_array)` — Takes a bash array of CLI names. Renders an ASCII table with columns: CLI, install, hook-fire, deny, inject. Uses `printf` fixed-width formatting. Prints PASS/FAIL/SKIP with visual alignment. Prints summary line: "X passed, Y failed, Z skipped".

**Markdown summary:**
- `write_markdown_summary(output_path)` — Generates a Markdown table of results. If `$GITHUB_STEP_SUMMARY` is set, also appends to it. Writes to `$output_path`.

**Create `e2e/run.sh`** as the main entry point (`#!/usr/bin/env bash`, `set -euo pipefail`):

1. Determine `E2E_ROOT` as the directory containing the script (`cd "$(dirname "$0")" && pwd`).
2. Source `$E2E_ROOT/lib/harness.sh` and `$E2E_ROOT/lib/reporting.sh`.
3. Call `harness_init` and `reporting_init`.
4. Parse optional `--cli <name>` arg to run only one CLI's scenarios. Default: discover all directories under `$E2E_ROOT/scenarios/`.
5. For each CLI directory found (e.g., `scenarios/claude-code/`):
   - Source each scenario script (`01-install.sh`, `02-hook-fire.sh`, etc.) in sorted order.
   - Each scenario script defines a function named `scenario_<name>` (e.g., `scenario_install`).
   - Call `run_scenario "$cli_name" "$scenario_name" "scenario_$scenario_name"` for each.
6. After all scenarios: call `print_results_table`, `write_junit_xml "$RUN_DIR/junit.xml"`, `write_markdown_summary "$RUN_DIR/summary.md"`.
7. Print paths to JUnit XML and Markdown files.
8. Exit with non-zero if `JUNIT_FAILURES > 0`.

Mark `e2e/run.sh` as executable.

**Update `Taskfile.yml`** — Add an `e2e` task in the Testing Tasks section:

```yaml
  e2e:
    desc: Run CLI E2E integration tests
    deps: [build-cli]
    cmds:
      - ./e2e/run.sh
    preconditions:
      - sh: test -f e2e/run.sh
        msg: "E2E harness not found. Expected e2e/run.sh"
```
  </action>
  <verify>
`bash -n e2e/lib/reporting.sh` exits 0 (no syntax errors).
`bash -n e2e/run.sh` exits 0 (no syntax errors).
`test -x e2e/run.sh` confirms executable.
`grep -q 'e2e:' Taskfile.yml` confirms task exists.
`grep -q 'e2e/run.sh' Taskfile.yml` confirms entry point wiring.
  </verify>
  <done>
`e2e/run.sh` is an executable entry point that sources harness + reporting libs, discovers CLI scenario directories, runs scenarios, and outputs JUnit XML + ASCII table + Markdown summary. `task e2e` invokes it after building the CLI.
  </done>
</task>

</tasks>

<verification>
1. `bash -n e2e/lib/harness.sh && bash -n e2e/lib/reporting.sh && bash -n e2e/run.sh` — all pass syntax check
2. `test -x e2e/run.sh` — run.sh is executable
3. `grep -q '.runs/' e2e/.gitignore` — gitignore covers run artifacts
4. `grep -q 'e2e:' Taskfile.yml` — Taskfile has e2e task
5. `grep -q 'source.*harness' e2e/run.sh` — run.sh sources harness
6. `grep -q 'source.*reporting' e2e/run.sh` — run.sh sources reporting
</verification>

<success_criteria>
- All 4 files (`harness.sh`, `reporting.sh`, `run.sh`, `.gitignore`) exist and pass bash syntax check
- `run.sh` is executable and sources both libraries
- Taskfile has `e2e` task that depends on `build-cli` and runs `e2e/run.sh`
- Harness provides workspace isolation, assertions, timing, and log snapshot functions
- Reporting generates JUnit XML, ASCII table, and Markdown summary
</success_criteria>

<output>
After completion, create `.planning/phases/23-claude-code-cli-e2e-testing/23-01-SUMMARY.md`
</output>
