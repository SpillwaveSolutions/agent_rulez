# Plan 18-02: Policy Enforcement + Tool Registration

**Phase:** 18 - OpenCode Plugin Integration  
**Plan:** 18-02 of 3  
**Requirements:** OPENCODE-03, OPENCODE-04  
**Depends on:** Plan 18-01  
**Estimated Duration:** 3-4 hours

## Goal

Invoke the RuleZ binary for policy checks, inject allow/deny/context responses into the OpenCode flow, and register RuleZ-driven tools in the OpenCode tool registry.

## Context

OpenCode plugin events should be evaluated by RuleZ and the resulting decision (allow, deny, or context injection) must be enforced in the OpenCode execution flow. In addition, OpenCode should expose custom RuleZ tools that run policy checks on demand.

## Success Criteria

- **SC-01**: RuleZ binary is invoked with mapped event payloads for policy decisions.
- **SC-02**: Allow/deny decisions are enforced for `tool.execute.before` and `file.edited` events.
- **SC-03**: Context injection responses are added to the OpenCode session when RuleZ returns injected content.
- **SC-04**: Custom OpenCode tools are registered and execute RuleZ checks on demand.

## Implementation Plan

### Task 1: Implement RuleZ execution adapter (60 min)

**Files:**
- `rulez_plugin/src/rulez/runner.rs` (new)
- `rulez_plugin/src/rulez/response.rs` (new)
- `rulez_plugin/src/opencode/dispatcher.rs` (update)

**Work:**
- Add a `rulez_run(event_payload)` adapter that invokes the RuleZ binary and captures stdout/stderr, exit code, and latency.
- Define a RuleZ response parser with explicit variants: allow, deny, inject, error.
- Wire the dispatcher to call `rulez_run` for before/after events.

### Task 2: Enforce policy decisions in OpenCode flow (60 min)

**Files:**
- `rulez_plugin/src/opencode/hooks.rs` (update)
- `rulez_plugin/src/opencode/dispatcher.rs` (update)
- `rulez_plugin/src/opencode/session.rs` (new)

**Work:**
- For `tool.execute.before` and `file.edited`, block execution when RuleZ returns deny (with clear reason).
- For allow responses, continue execution with no changes.
- For inject responses, append the injected context to the OpenCode session state.
- Ensure `tool.execute.after` and `session.updated` still log outcomes but do not block.

### Task 3: Register RuleZ tools in OpenCode (45 min)

**Files:**
- `rulez_plugin/src/opencode/tools.rs` (new)
- `rulez_plugin/src/opencode/mod.rs` (update)

**Work:**
- Register tools such as `rulez.check` and `rulez.explain` that call the RuleZ binary with explicit arguments.
- Return structured tool responses (status, reason, optional injected content).
- Ensure tools reuse the same payload mapping as event hooks for consistency.

## File Changes

### New Files (4)
- `rulez_plugin/src/rulez/runner.rs`
- `rulez_plugin/src/rulez/response.rs`
- `rulez_plugin/src/opencode/session.rs`
- `rulez_plugin/src/opencode/tools.rs`

### Modified Files (3)
- `rulez_plugin/src/opencode/dispatcher.rs`
- `rulez_plugin/src/opencode/hooks.rs`
- `rulez_plugin/src/opencode/mod.rs`

## Testing Strategy

```bash
cargo test -p rulez-plugin
```

## Next Steps

Proceed to Plan 18-03 (Plugin Config + Audit Logging).

---

*Plan created: 2026-02-11*  
*Phase 18, Plan 2 of 3*
