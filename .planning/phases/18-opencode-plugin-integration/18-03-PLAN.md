# Plan 18-03: Plugin Config + Audit Logging

**Phase:** 18 - OpenCode Plugin Integration  
**Plan:** 18-03 of 3  
**Requirements:** OPENCODE-05, OPENCODE-06  
**Depends on:** Plan 18-02  
**Estimated Duration:** 2-3 hours

## Goal

Add OpenCode plugin configuration support and a structured audit log that captures all RuleZ interactions with plugin metadata.

## Context

The OpenCode plugin must read configuration from `~/.config/opencode/plugins/rulez-plugin/` and log each RuleZ interaction with metadata (plugin version, event type, decision, latency). This data should be emitted to an audit trail in JSONL format to enable later analysis.

## Success Criteria

- **SC-01**: Plugin reads configuration from the OpenCode plugin config directory with sane defaults.
- **SC-02**: Config supports RuleZ binary path, audit log path, and event filters.
- **SC-03**: Every RuleZ interaction emits a JSONL audit entry with plugin metadata and decision outcome.
- **SC-04**: Audit logging is non-blocking and resilient to file write failures.

## Implementation Plan

### Task 1: Add plugin config loader (60 min)

**Files:**
- `rulez_plugin/src/opencode/config.rs` (new)
- `rulez_plugin/src/opencode/defaults.rs` (new)
- `rulez_plugin/src/opencode/mod.rs` (update)

**Work:**
- Define a config schema (JSON or TOML) stored under `~/.config/opencode/plugins/rulez-plugin/`.
- Load config on plugin startup with defaults for `rulez_binary_path`, `audit_log_path`, and `event_filters`.
- Support environment variable overrides for binary path and audit log destination.

### Task 2: Implement audit logger (60 min)

**Files:**
- `rulez_plugin/src/opencode/audit.rs` (new)
- `rulez_plugin/src/opencode/dispatcher.rs` (update)

**Work:**
- Write audit entries as JSONL with fields: timestamp, event_id, event_name, decision, reason, latency_ms, plugin_name, plugin_version, opencode_session_id.
- Ensure logging does not block policy decisions (async or buffered writes).
- If audit logging fails, record a warning and continue (no hard failure).

### Task 3: Wire config + audit into dispatcher (30 min)

**Files:**
- `rulez_plugin/src/opencode/dispatcher.rs` (update)
- `rulez_plugin/src/opencode/hooks.rs` (update)

**Work:**
- Load config once and pass into dispatcher.
- Apply event filters before RuleZ invocation (skip filtered event types).
- Attach plugin metadata to audit entries for every dispatched event.

## File Changes

### New Files (3)
- `rulez_plugin/src/opencode/config.rs`
- `rulez_plugin/src/opencode/defaults.rs`
- `rulez_plugin/src/opencode/audit.rs`

### Modified Files (2)
- `rulez_plugin/src/opencode/dispatcher.rs`
- `rulez_plugin/src/opencode/hooks.rs`

## Testing Strategy

```bash
cargo test -p rulez-plugin
```

## Next Steps

Phase 18 complete. Proceed to Phase 19 (Gemini CLI Hook Integration).

---

*Plan created: 2026-02-11*  
*Phase 18, Plan 3 of 3*
