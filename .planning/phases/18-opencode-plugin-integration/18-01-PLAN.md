# Plan 18-01: OpenCode Event Capture + RuleZ Payload Mapping

**Phase:** 18 - OpenCode Plugin Integration  
**Plan:** 18-01 of 3  
**Requirements:** OPENCODE-01, OPENCODE-02  
**Depends on:** Phase 17 completion  
**Estimated Duration:** 3-4 hours

## Goal

Capture OpenCode plugin lifecycle events and map them into a normalized RuleZ event payload that can be consumed by downstream policy evaluation.

## Context

OpenCode plugin integration must emit RuleZ hook events for key lifecycle moments and provide a consistent payload shape that includes project and runtime context. The required events are:

- `file.edited`
- `tool.execute.before`
- `tool.execute.after`
- `session.updated`

Each emitted event must include context fields (project, directory, worktree, client SDK, shell) mapped into the RuleZ event payload.

## Success Criteria

- **SC-01**: OpenCode lifecycle hooks emit the four required events with stable event names.
- **SC-02**: RuleZ event payload includes mapped context fields for project path, working directory, worktree, client SDK metadata, and shell environment.
- **SC-03**: Event payloads serialize deterministically (stable keys, required fields present, optional fields nullable).
- **SC-04**: A single internal dispatch path accepts all OpenCode events for later policy evaluation.

## Implementation Plan

### Task 1: Add OpenCode event hook wiring (45 min)

**Files:**
- `rulez_plugin/src/opencode/hooks.rs` (new)
- `rulez_plugin/src/opencode/mod.rs` (update)
- `rulez_plugin/src/lib.rs` or `rulez_plugin/src/main.rs` (update)

**Work:**
- Register OpenCode plugin hooks for `file.edited`, `tool.execute.before`, `tool.execute.after`, and `session.updated`.
- Normalize incoming event names to the RuleZ naming conventions above.
- Capture raw OpenCode event data with timestamps and a generated event ID.

### Task 2: Build RuleZ payload mapper (60 min)

**Files:**
- `rulez_plugin/src/opencode/payload.rs` (new)
- `rulez_plugin/src/opencode/context.rs` (new)
- `rulez_plugin/src/types/rulez_event.rs` (new)
- `rulez_plugin/tests/opencode_payload_tests.rs` (new)

**Work:**
- Define a RuleZ event payload struct with required top-level fields (event name, timestamp, id, context, payload).
- Map OpenCode context into RuleZ fields: project root, current directory, worktree root, client SDK name/version, shell info ($SHELL, platform, cwd).
- Normalize missing fields to `null` or empty strings as appropriate (no panics on missing metadata).
- Add unit tests covering each event type and edge cases (missing worktree, absent SDK info).

### Task 3: Create event dispatch stub (30 min)

**Files:**
- `rulez_plugin/src/opencode/dispatcher.rs` (new)
- `rulez_plugin/src/opencode/mod.rs` (update)

**Work:**
- Add a central `dispatch_event(payload)` function that all hooks call.
- For now, dispatch should return a placeholder decision (allow) and capture duration for later policy evaluation.

## File Changes

### New Files (6)
- `rulez_plugin/src/opencode/hooks.rs`
- `rulez_plugin/src/opencode/payload.rs`
- `rulez_plugin/src/opencode/context.rs`
- `rulez_plugin/src/opencode/dispatcher.rs`
- `rulez_plugin/src/types/rulez_event.rs`
- `rulez_plugin/tests/opencode_payload_tests.rs`

### Modified Files (2)
- `rulez_plugin/src/opencode/mod.rs`
- `rulez_plugin/src/lib.rs` or `rulez_plugin/src/main.rs`

## Testing Strategy

```bash
cargo test -p rulez-plugin
```

## Next Steps

Proceed to Plan 18-02 (Policy Enforcement + Tool Registration).

---

*Plan created: 2026-02-11*  
*Phase 18, Plan 1 of 3*
