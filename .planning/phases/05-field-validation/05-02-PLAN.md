---
phase: 05-field-validation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - rulez/src/hooks.rs
  - rulez/src/models.rs
autonomous: true

must_haves:
  truths:
    - "Rules with require_fields block when required fields are missing from tool_input"
    - "Rules with field_types block when field type does not match expected type"
    - "Null JSON values are treated as missing for require_fields checks"
    - "Missing tool_input causes all field validation to fail (fail-closed)"
    - "All field errors are accumulated and reported together, not just the first"
    - "Error messages show types only, not actual field values"
    - "field_types implies require_fields (field must exist AND match type)"
    - "Empty strings and empty arrays count as present"
    - "Debug mode reports field validation results in MatcherResults"
  artifacts:
    - path: "rulez/src/hooks.rs"
      provides: "validate_required_fields function, field validation in matches_rule and matches_rule_with_debug"
      contains: "validate_required_fields"
    - path: "rulez/src/models.rs"
      provides: "field_validation_matched field in MatcherResults"
      contains: "field_validation_matched"
  key_links:
    - from: "rulez/src/hooks.rs"
      to: "rulez/src/models.rs"
      via: "Uses dot_to_pointer, require_fields, field_types from Matchers"
      pattern: "dot_to_pointer|require_fields|field_types"
    - from: "rulez/src/hooks.rs"
      to: "serde_json::Value::pointer"
      via: "JSON Pointer field access for nested field validation"
      pattern: "pointer"
---

<objective>
Implement field validation matching logic in hooks.rs — validate required fields exist and match expected types in tool_input JSON during rule evaluation.

Purpose: This is the core runtime logic that makes field validation work. Rules with require_fields or field_types will block tool execution when fields are missing or types don't match, enforcing fail-closed behavior consistent with enabled_when and prompt_match.

Output: Updated hooks.rs with validate_required_fields function integrated into matches_rule and matches_rule_with_debug, plus MatcherResults extension for debug mode.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-field-validation/05-CONTEXT.md
@.planning/phases/05-field-validation/05-RESEARCH.md
@.planning/phases/05-field-validation/05-01-SUMMARY.md
@rulez/src/hooks.rs
@rulez/src/models.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add field_validation_matched to MatcherResults and implement validate_required_fields</name>
  <files>rulez/src/models.rs, rulez/src/hooks.rs</files>
  <action>
  **In models.rs:**
  Add a new field to MatcherResults (after prompt_match_matched):
  ```rust
  /// Whether field validation (require_fields/field_types) passed
  #[serde(skip_serializing_if = "Option::is_none")]
  pub field_validation_matched: Option<bool>,
  ```

  **In hooks.rs:**
  Add a new section after the prompt matching section (after matches_prompt function, before process_event):

  ```rust
  // =============================================================================
  // Field Validation (Phase 5)
  // =============================================================================

  /// Validate required fields and field types in tool_input JSON
  ///
  /// Returns Ok(true) if all validations pass, Ok(false) if any fail.
  /// Collects ALL errors before returning (does not short-circuit).
  ///
  /// Behavior:
  /// - Missing tool_input -> all checks fail (fail-closed)
  /// - Null values -> treated as missing
  /// - Empty strings/arrays -> treated as present (JSON semantics)
  /// - field_types implies require_fields (field must exist AND match type)
  /// - Error messages show types only, not actual values (security)
  fn validate_required_fields(rule: &Rule, event: &Event) -> bool {
  ```

  Implementation details for validate_required_fields:
  1. Import `dot_to_pointer` from `crate::models`
  2. Check if rule has require_fields or field_types — if neither, return true (no validation needed)
  3. Get tool_input from event:
     - If tool_input is None → log warning and return false (fail-closed)
     - If tool_input is not an object → log warning and return false
  4. Build combined field set:
     - Start with require_fields (if any)
     - Add field_types keys that are NOT already in require_fields (field_types implies existence)
  5. For each field in combined set:
     - Convert dot path to JSON Pointer via dot_to_pointer()
     - Use tool_input.pointer(&pointer_path) to look up value
     - If None → add error: "field '{path}' is missing"
     - If Some(Value::Null) → add error: "field '{path}' is null (treated as missing)"
     - If present and field has a type specifier in field_types → validate type
  6. For type validation:
     - Match expected type against: "string" -> is_string(), "number" -> is_number(), "boolean" -> is_boolean(), "array" -> is_array(), "object" -> is_object(), "any" -> always passes
     - On mismatch → add error: "field '{path}' expected {expected_type}, got {actual_type}"
     - actual_type derived from Value variant: String->"string", Number->"number", Bool->"boolean", Array->"array", Object->"object", Null->"null"
  7. If any errors collected:
     - Log all errors as a single warning: "Field validation failed for rule '{name}': {errors joined with '; '}"
     - Return false
  8. Otherwise return true

  Do NOT leak actual field values in error messages — show types only per user constraint.
  </action>
  <verify>
  `cargo check --package rulez` passes with no errors.
  </verify>
  <done>
  validate_required_fields function exists in hooks.rs. It handles missing tool_input (fail-closed), null values (treated as missing), type validation, and accumulates all errors before returning. Error messages show types only. MatcherResults has field_validation_matched field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate field validation into matches_rule and matches_rule_with_debug</name>
  <files>rulez/src/hooks.rs</files>
  <action>
  **In matches_rule function:**
  Add field validation check AFTER the prompt_match check block (before the final `true` return). This positioning means field validation acts as an additional matcher condition — if it fails, the rule doesn't match:

  ```rust
  // Check field validation (require_fields / field_types)
  if rule.matchers.require_fields.is_some() || rule.matchers.field_types.is_some() {
      if !validate_required_fields(rule, event) {
          return false;
      }
  }
  ```

  **In matches_rule_with_debug function:**
  Add the same check in the debug version (after prompt_match_matched handling), recording the result:

  ```rust
  // Check field validation (require_fields / field_types)
  if rule.matchers.require_fields.is_some() || rule.matchers.field_types.is_some() {
      let field_valid = validate_required_fields(rule, event);
      matcher_results.field_validation_matched = Some(field_valid);
      if !field_valid {
          overall_match = false;
      }
  }
  ```

  Update all existing test helper Matchers instantiations in hooks.rs tests to include `require_fields: None, field_types: None,` to prevent compilation errors.

  Add basic inline unit tests in hooks.rs for validate_required_fields:
  - test_field_validation_no_fields_configured: rule with no require_fields/field_types -> returns true
  - test_field_validation_missing_tool_input: rule with require_fields but event has no tool_input -> returns false
  - test_field_validation_present_field: tool_input has required field -> returns true
  - test_field_validation_missing_field: tool_input missing required field -> returns false
  - test_field_validation_null_field_is_missing: tool_input has null field -> returns false
  - test_field_validation_nested_field: dot notation "user.name" resolves correctly
  - test_field_validation_type_match: field_types {count: number} with number value -> true
  - test_field_validation_type_mismatch: field_types {count: number} with string value -> false
  - test_field_validation_empty_string_is_present: "" counts as present
  - test_field_validation_empty_array_is_present: [] counts as present
  - test_field_validation_any_type: field_types {data: any} accepts any non-null value
  - test_field_validation_field_types_implies_existence: field in field_types but not require_fields still checked for existence
  </action>
  <verify>
  `cargo check --package rulez` passes.
  `cargo test --package rulez -- test_field_validation` passes all field validation unit tests.
  `cargo test --package rulez` — all tests pass (no regressions).
  </verify>
  <done>
  Field validation is integrated into both matches_rule and matches_rule_with_debug. Rules with require_fields/field_types block when validation fails. Debug mode reports field_validation_matched. All 12+ new tests pass. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
- `cargo check --package rulez` compiles without errors
- `cargo test --package rulez` — all tests pass including new field validation tests
- Rules with require_fields block when fields are missing
- Rules with field_types block when types mismatch
- Null values treated as missing
- Missing tool_input causes fail-closed behavior
- All errors accumulated and reported together
- Empty strings and arrays count as present
- Debug mode tracks field_validation_matched
</verification>

<success_criteria>
- validate_required_fields correctly validates field existence and types
- Field validation integrated as a matcher condition in rule evaluation
- Fail-closed on missing tool_input, null values, and type mismatches
- All errors collected (not short-circuited) per user constraint
- Error messages show types only, never actual values
- field_types implies require_fields
- All 407+ existing tests still pass with new fields added
</success_criteria>

<output>
After completion, create `.planning/phases/05-field-validation/05-02-SUMMARY.md`
</output>
