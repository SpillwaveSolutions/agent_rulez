---
phase: 05-field-validation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - rulez/tests/field_validation_integration.rs
  - rulez/src/models.rs
  - rulez/src/hooks.rs
autonomous: true

must_haves:
  truths:
    - "End-to-end field validation works through CLI debug command"
    - "FIELD-01 covered: require_fields validates field existence in tool_input"
    - "FIELD-02 covered: missing required fields cause blocking (fail-closed)"
    - "FIELD-03 covered: nested field paths with dot notation resolve correctly"
    - "FIELD-04 covered: field type mismatches cause blocking"
    - "All edge cases tested: null values, empty strings/arrays, missing tool_input, deep nesting"
  artifacts:
    - path: "rulez/tests/field_validation_integration.rs"
      provides: "Integration tests for field validation end-to-end"
      contains: "field_validation"
    - path: "rulez/src/models.rs"
      provides: "Comprehensive unit tests for field validation types"
      contains: "test_require_fields"
    - path: "rulez/src/hooks.rs"
      provides: "Comprehensive unit tests for validate_required_fields"
      contains: "test_field_validation"
  key_links:
    - from: "rulez/tests/field_validation_integration.rs"
      to: "rulez/src/hooks.rs"
      via: "Integration tests exercise process_event with field validation rules"
      pattern: "process_event|hooks\\.yaml"
---

<objective>
Add comprehensive test coverage for field validation, covering all FIELD requirements with unit tests and end-to-end integration tests.

Purpose: Ensure all four FIELD requirements (FIELD-01 through FIELD-04) are thoroughly tested, including edge cases identified in research (null values, empty containers, missing tool_input, deep nesting). Integration tests verify the full stack from YAML config through rule evaluation to response.

Output: Integration test file for field validation, plus additional unit tests in models.rs and hooks.rs covering edge cases and requirement traceability.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-field-validation/05-CONTEXT.md
@.planning/phases/05-field-validation/05-RESEARCH.md
@.planning/phases/05-field-validation/05-01-SUMMARY.md
@.planning/phases/05-field-validation/05-02-SUMMARY.md
@.planning/phases/04-prompt-matching/04-04-SUMMARY.md
@rulez/tests/prompt_match_integration.rs
@rulez/src/models.rs
@rulez/src/hooks.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive unit tests for field validation in models.rs and hooks.rs</name>
  <files>rulez/src/models.rs, rulez/src/hooks.rs</files>
  <action>
  **In models.rs — add unit tests for dot_to_pointer edge cases and Matchers deserialization:**

  Tests for dot_to_pointer (if not already covered in 05-01):
  - test_dot_to_pointer_single_segment: "name" -> "/name"
  - test_dot_to_pointer_multiple_segments: "a.b.c" -> "/a/b/c"
  - test_dot_to_pointer_tilde_escape: "a~b" -> "/a~0b"
  - test_dot_to_pointer_slash_escape: "a/b" -> "/a~1b"
  - test_dot_to_pointer_combined_escapes: "a~b.c/d" -> "/a~0b/c~1d"

  Tests for Matchers YAML deserialization with require_fields and field_types:
  - test_matchers_require_fields_deserialization: YAML with require_fields parses correctly
  - test_matchers_field_types_deserialization: YAML with field_types parses correctly
  - test_matchers_both_require_and_types: YAML with both fields parses correctly
  - test_matchers_require_fields_with_nested_paths: dot notation paths parse correctly
  - test_matchers_without_field_validation: Matchers without require_fields/field_types still work

  **In hooks.rs — add comprehensive unit tests for validate_required_fields covering all FIELD requirements:**

  FIELD-01 tests (require specific fields):
  - test_field_validation_single_required_field_present
  - test_field_validation_multiple_required_fields_all_present
  - test_field_validation_multiple_required_fields_one_missing

  FIELD-02 tests (fail-closed blocking):
  - test_field_validation_blocks_on_missing_field
  - test_field_validation_blocks_on_null_field
  - test_field_validation_blocks_on_missing_tool_input
  - test_field_validation_blocks_on_non_object_tool_input (e.g., tool_input is a string or array)

  FIELD-03 tests (nested paths with dot notation):
  - test_field_validation_nested_one_level: "user.name"
  - test_field_validation_nested_three_levels: "input.user.address.city"
  - test_field_validation_nested_missing_intermediate: "user.address.city" where "user" has no "address"
  - test_field_validation_nested_mixed_present_and_missing

  FIELD-04 tests (type validation):
  - test_field_types_string_match
  - test_field_types_number_match
  - test_field_types_boolean_match
  - test_field_types_array_match
  - test_field_types_object_match
  - test_field_types_any_match_with_string
  - test_field_types_any_match_with_number
  - test_field_types_string_mismatch_with_number
  - test_field_types_number_mismatch_with_string
  - test_field_types_all_errors_accumulated (multiple fields fail, all reported)

  Edge case tests:
  - test_field_validation_empty_string_is_present: require_fields with "" value -> passes
  - test_field_validation_empty_array_is_present: require_fields with [] value -> passes
  - test_field_validation_empty_object_is_present: require_fields with {} value -> passes
  - test_field_validation_field_types_implies_existence: field only in field_types but not require_fields -> still checked

  Follow the OQ (Operational Qualification) pattern from Phase 4 tests.
  </action>
  <verify>
  `cargo test --package rulez -- test_dot_to_pointer` passes all pointer tests.
  `cargo test --package rulez -- test_field_validation` passes all field validation tests.
  `cargo test --package rulez -- test_field_types` passes all type validation tests.
  `cargo test --package rulez -- test_matchers_require` passes all deserialization tests.
  `cargo test --package rulez` — all tests pass.
  </verify>
  <done>
  Comprehensive unit tests cover all four FIELD requirements plus edge cases. At least 30 new tests added across models.rs and hooks.rs. All tests pass. Test names include requirement traceability (FIELD-01 through FIELD-04 coverage).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add end-to-end integration tests for field validation</name>
  <files>rulez/tests/field_validation_integration.rs</files>
  <action>
  Create a new integration test file `rulez/tests/field_validation_integration.rs` following the pattern established in `rulez/tests/prompt_match_integration.rs`:

  Structure:
  ```rust
  //! Field Validation Integration Tests (OQ - Operational Qualification)
  //!
  //! End-to-end tests verifying field validation through the full stack:
  //! YAML config -> Config::from_file -> process_event -> Response
  //!
  //! Requirements covered: FIELD-01, FIELD-02, FIELD-03, FIELD-04
  ```

  Use the common test helpers pattern:
  - Create temp directory with .claude/hooks.yaml
  - Write YAML config with rules that have require_fields and/or field_types
  - Create Event with appropriate tool_input
  - Call process_event and verify Response

  Integration tests:

  **FIELD-01: Require specific fields exist**
  - test_e2e_require_fields_present_allows: rule requires ["file_path"], event has file_path -> allowed
  - test_e2e_require_fields_missing_blocks: rule requires ["file_path"], event missing it -> blocked

  **FIELD-02: Fail-closed blocking**
  - test_e2e_require_fields_no_tool_input_blocks: rule with require_fields but event has no tool_input -> blocked
  - test_e2e_require_fields_null_value_blocks: rule requires ["name"], tool_input has name: null -> blocked

  **FIELD-03: Dot notation nested paths**
  - test_e2e_nested_field_present_allows: require_fields: ["user.name"], tool_input has nested user.name -> allowed
  - test_e2e_nested_field_missing_blocks: require_fields: ["user.email"], nested field missing -> blocked
  - test_e2e_deep_nested_field: require_fields: ["a.b.c.d"], deep nesting works

  **FIELD-04: Type validation**
  - test_e2e_field_types_correct_allows: field_types: {count: number}, count is 42 -> allowed
  - test_e2e_field_types_mismatch_blocks: field_types: {count: number}, count is "42" -> blocked
  - test_e2e_field_types_multiple_types: validate multiple field types at once
  - test_e2e_field_types_implies_existence: field in field_types only (not require_fields) still checked

  **Combined tests:**
  - test_e2e_require_and_types_together: both require_fields and field_types on same rule
  - test_e2e_field_validation_with_tool_matcher: require_fields combined with tools matcher

  **Config validation integration:**
  - test_e2e_invalid_field_path_rejected: config with ".name" in require_fields -> error at load time
  - test_e2e_invalid_type_specifier_rejected: config with "integer" in field_types -> error at load time

  Each test should follow the OQ pattern:
  1. Create temp dir with hooks.yaml
  2. Set up Event with appropriate data
  3. Call process_event
  4. Assert Response (continue_ true/false, appropriate reason)

  Save test evidence to target/test-evidence/ following Phase 4 pattern.
  </action>
  <verify>
  `cargo test --package rulez --test field_validation_integration` passes all integration tests.
  `cargo test --package rulez` — all tests pass (no regressions).
  Test count increased by at least 15 integration tests.
  </verify>
  <done>
  End-to-end integration tests verify all four FIELD requirements through the full stack. Tests exercise YAML parsing, config validation, rule evaluation, and response generation. At least 15 integration tests pass. Total test count exceeds 430.
  </done>
</task>

</tasks>

<verification>
- `cargo test --package rulez` — ALL tests pass including new unit and integration tests
- FIELD-01: At least 3 tests verify require_fields field existence checking
- FIELD-02: At least 3 tests verify fail-closed blocking behavior
- FIELD-03: At least 3 tests verify dot notation nested path resolution
- FIELD-04: At least 5 tests verify field type validation
- Edge cases: null values, empty containers, missing tool_input all tested
- Integration tests exercise full stack from YAML config through response
</verification>

<success_criteria>
- All four FIELD requirements have dedicated test coverage
- Unit tests in models.rs and hooks.rs cover type utilities and validation logic
- Integration tests in field_validation_integration.rs cover end-to-end flows
- At least 45 new tests added total (30+ unit, 15+ integration)
- All existing tests still pass (no regressions)
- Total test count exceeds 430 (from baseline 407)
</success_criteria>

<output>
After completion, create `.planning/phases/05-field-validation/05-03-SUMMARY.md`
</output>
