# Plan 17-01: Comprehensive Feature Test Coverage

**Phase:** 17 - E2E Testing  
**Plan:** 17-01 of 2  
**Requirements:** E2E-01, E2E-02 (partial)  
**Depends on:** Phase 16 completion  
**Estimated Duration:** 4-6 hours

## Goal

Create comprehensive Playwright E2E test coverage for all v1.6 features (Settings, Enhanced Editor, Log Viewer, Config Management, Debug Simulator, Onboarding) using Page Object Model pattern and existing test infrastructure.

## Context

**Current Test Coverage:**
- ✅ Basic app shell (app.spec.ts - 93 lines)
- ✅ Editor basics (editor.spec.ts - 57 lines)
- ✅ File operations (file-ops.spec.ts - 82 lines)
- ✅ Simulator (simulator.spec.ts - 71 lines)
- ✅ Tree view (tree-view.spec.ts - 50 lines)
- **Total:** 353 lines, 5 spec files

**Existing Page Objects:**
- ✅ Base page (base.page.ts)
- ✅ App shell page (app-shell.page.ts)
- ✅ Editor page (editor.page.ts)
- ✅ File tab bar page (file-tab-bar.page.ts)
- ✅ Sidebar page (sidebar.page.ts)
- ✅ Simulator page (simulator.page.ts)
- ✅ Dialogs page (dialogs.page.ts)

**Gap Analysis:**
- ❌ No tests for Settings panel (Phase 11)
- ❌ No tests for Monaco autocomplete/error markers (Phase 12)
- ❌ No tests for Log Viewer (Phase 13)
- ❌ No tests for Config Management import/export (Phase 14)
- ❌ No tests for Debug Simulator real binary integration (Phase 15)
- ❌ No tests for Onboarding wizard (Phase 16)

## Success Criteria

- [ ] **SC-01**: Settings panel tests cover theme toggle, font size, binary path configuration
- [ ] **SC-02**: Editor enhancement tests cover autocomplete trigger, error marker display, format on save
- [ ] **SC-03**: Log viewer tests cover filtering, search, export, virtual scrolling
- [ ] **SC-04**: Config management tests cover scope switching, import/export, live reload simulation
- [ ] **SC-05**: Simulator tests cover real binary invocation (mocked in web mode), test case save/load
- [ ] **SC-06**: Onboarding tests cover wizard flow, binary detection, sample config generation
- [ ] **SC-07**: All new tests use Page Object Model pattern for maintainability
- [ ] **SC-08**: Test coverage increases from 353 lines to ~800+ lines

## Implementation Plan

### Task 1: Create New Page Objects (45 min)

**Page Objects to Create:**

1. **SettingsPage** (`tests/pages/settings.page.ts`)
   ```typescript
   class SettingsPage extends BasePage {
     async openSettings(): Promise<void>
     async selectTheme(theme: 'light' | 'dark' | 'system'): Promise<void>
     async setFontSize(size: number): Promise<void>
     async setBinaryPath(path: string): Promise<void>
     async saveSettings(): Promise<void>
     async getTheme(): Promise<string>
   }
   ```

2. **LogViewerPage** (`tests/pages/log-viewer.page.ts`)
   ```typescript
   class LogViewerPage extends BasePage {
     async openLogViewer(): Promise<void>
     async filterByText(text: string): Promise<void>
     async filterBySeverity(level: string): Promise<void>
     async exportLogs(format: 'json' | 'csv'): Promise<void>
     async getVisibleLogCount(): Promise<number>
     async copyLogEntry(index: number): Promise<void>
   }
   ```

3. **ConfigManagerPage** (`tests/pages/config-manager.page.ts`)
   ```typescript
   class ConfigManagerPage extends BasePage {
     async switchScope(scope: 'global' | 'project'): Promise<void>
     async importConfig(filename: string): Promise<void>
     async exportConfig(filename: string): Promise<void>
     async getScopeIndicator(): Promise<string>
   }
   ```

4. **OnboardingPage** (`tests/pages/onboarding.page.ts`)
   ```typescript
   class OnboardingPage extends BasePage {
     async isWizardVisible(): Promise<boolean>
     async checkBinaryDetection(): Promise<boolean>
     async generateSampleConfig(): Promise<void>
     async runTestSimulation(): Promise<void>
     async completeWizard(): Promise<void>
     async skipOnboarding(): Promise<void>
   }
   ```

**Files:**
- `tests/pages/settings.page.ts` (new)
- `tests/pages/log-viewer.page.ts` (new)
- `tests/pages/config-manager.page.ts` (new)
- `tests/pages/onboarding.page.ts` (new)
- `tests/pages/index.ts` (update exports)

### Task 2: Settings Panel Tests (30 min)

**Test File:** `tests/settings.spec.ts`

**Test Cases:**
1. ✓ Should open settings panel from toolbar
2. ✓ Should toggle theme and persist across reload
3. ✓ Should change editor font size and apply immediately
4. ✓ Should configure binary path with validation
5. ✓ Should save settings and show success feedback
6. ✓ Should restore default settings

**Estimated Lines:** ~120

**Files:**
- `tests/settings.spec.ts` (new)

### Task 3: Enhanced Editor Tests (40 min)

**Test File:** `tests/editor-enhanced.spec.ts`

**Test Cases:**
1. ✓ Should trigger autocomplete on typing rule field names
2. ✓ Should show red squiggles for YAML syntax errors
3. ✓ Should show error panel with clickable error entries
4. ✓ Should format YAML on save (indentation correction)
5. ✓ Should dispose Monaco models on file switch (no memory leak)
6. ✓ Should show live preview panel with parsed rules
7. ✓ Should jump to line on error click

**Estimated Lines:** ~150

**Files:**
- `tests/editor-enhanced.spec.ts` (new)

### Task 4: Log Viewer Tests (45 min)

**Test File:** `tests/log-viewer.spec.ts`

**Test Cases:**
1. ✓ Should display log entries from mock data
2. ✓ Should filter logs by text search
3. ✓ Should filter logs by severity level
4. ✓ Should filter logs by date range
5. ✓ Should handle large log files (100K+ entries) with virtual scrolling
6. ✓ Should export filtered logs to JSON
7. ✓ Should export filtered logs to CSV
8. ✓ Should copy log entry to clipboard

**Estimated Lines:** ~180

**Files:**
- `tests/log-viewer.spec.ts` (new)
- `tests/fixtures/mock-logs.json` (new - sample log data)

### Task 5: Config Management Tests (40 min)

**Test File:** `tests/config-management.spec.ts`

**Test Cases:**
1. ✓ Should switch between global and project scope
2. ✓ Should show scope indicator (badge/label)
3. ✓ Should import config file with validation
4. ✓ Should reject invalid YAML on import
5. ✓ Should export current config to file
6. ✓ Should show precedence (project overrides global)
7. ✓ Should simulate live reload on external file change

**Estimated Lines:** ~140

**Files:**
- `tests/config-management.spec.ts` (new)
- `tests/fixtures/valid-config.yaml` (new)
- `tests/fixtures/invalid-config.yaml` (new)

### Task 6: Debug Simulator Enhanced Tests (30 min)

**Extend:** `tests/simulator.spec.ts`

**New Test Cases:**
1. ✓ Should invoke real binary (mocked response in web mode)
2. ✓ Should show step-by-step rule evaluation trace
3. ✓ Should save debug test case
4. ✓ Should load and replay saved test case
5. ✓ Should show which rules matched and why

**Estimated New Lines:** ~100

**Files:**
- `tests/simulator.spec.ts` (extend existing - add 100 lines)

### Task 7: Onboarding Tests (40 min)

**Test File:** `tests/onboarding.spec.ts`

**Test Cases:**
1. ✓ Should show wizard on first launch (clean state)
2. ✓ Should detect if binary is installed
3. ✓ Should show binary not found message with download link
4. ✓ Should generate sample config with example rules
5. ✓ Should guide through test simulation
6. ✓ Should complete wizard and hide on subsequent launches
7. ✓ Should re-run wizard from settings panel

**Estimated Lines:** ~130

**Files:**
- `tests/onboarding.spec.ts` (new)

### Task 8: Test Fixtures & Utilities (20 min)

**New Fixtures:**
- `tests/fixtures/mock-logs.json` - Sample log entries (100-1000 entries)
- `tests/fixtures/valid-config.yaml` - Valid YAML config
- `tests/fixtures/invalid-config.yaml` - Invalid YAML for error testing
- `tests/fixtures/sample-events.json` - Debug simulator test events

**Utility Functions:**
- `tests/utils/reset-app-state.ts` - Clear localStorage/IndexedDB for clean test state
- `tests/utils/mock-binary-response.ts` - Mock rulez binary responses in web mode

**Files:**
- `tests/fixtures/mock-logs.json` (new)
- `tests/fixtures/valid-config.yaml` (new)
- `tests/fixtures/invalid-config.yaml` (new)
- `tests/fixtures/sample-events.json` (new)
- `tests/utils/reset-app-state.ts` (new)
- `tests/utils/mock-binary-response.ts` (new)

## File Changes

### New Files (15)
- `tests/pages/settings.page.ts` (~150 lines)
- `tests/pages/log-viewer.page.ts` (~180 lines)
- `tests/pages/config-manager.page.ts` (~120 lines)
- `tests/pages/onboarding.page.ts` (~140 lines)
- `tests/settings.spec.ts` (~120 lines)
- `tests/editor-enhanced.spec.ts` (~150 lines)
- `tests/log-viewer.spec.ts` (~180 lines)
- `tests/config-management.spec.ts` (~140 lines)
- `tests/onboarding.spec.ts` (~130 lines)
- `tests/fixtures/mock-logs.json` (~50 lines)
- `tests/fixtures/valid-config.yaml` (~30 lines)
- `tests/fixtures/invalid-config.yaml` (~10 lines)
- `tests/fixtures/sample-events.json` (~40 lines)
- `tests/utils/reset-app-state.ts` (~50 lines)
- `tests/utils/mock-binary-response.ts` (~80 lines)

### Modified Files (2)
- `tests/simulator.spec.ts` (+100 lines - extend with real binary tests)
- `tests/pages/index.ts` (+4 lines - export new page objects)

**Total New Lines:** ~1,550  
**Coverage Increase:** 353 → ~1,900 lines (439% increase)

## Testing Strategy

### Test Execution
```bash
# Run all tests
bunx playwright test

# Run specific feature tests
bunx playwright test tests/settings.spec.ts
bunx playwright test tests/log-viewer.spec.ts

# Run in headed mode for debugging
bunx playwright test --headed

# Run with UI for interactive debugging
bunx playwright test --ui
```

### Mock Data Strategy
- All tests run in **web mode** (not Tauri desktop mode)
- Mock Tauri commands return realistic responses
- Use `tests/utils/mock-binary-response.ts` for consistent binary mocks
- Reset app state before each test suite with `reset-app-state.ts`

### Page Object Benefits
- Centralized selectors (easier to maintain when UI changes)
- Reusable actions across test files
- Clear separation: tests describe behavior, pages describe UI structure
- Reduces test brittleness

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Async timing issues with Monaco editor | High | Use `waitForSelector` with explicit timeouts, wait for editor.onDidChangeModelContent events |
| Virtual scrolling breaks test selectors | Medium | Use data-testid attributes on log entries, test visible subset only |
| localStorage persistence across tests | Medium | Create `reset-app-state.ts` utility, call in beforeEach hooks |
| Mock data doesn't match real binary output | Low | Copy exact JSON from real `rulez debug` output |

## Dependencies

**Blocking:**
- Phase 16 (Onboarding) must be complete before onboarding tests can be written
- Settings panel (Phase 11) UI must exist before tests can be written
- Log viewer component (Phase 13) must be implemented

**Non-blocking:**
- Tests can be written incrementally as each phase completes
- Page objects can be scaffolded before UI implementation for TDD approach

## Success Metrics

- [ ] **M1**: 4 new page objects created with full method coverage
- [ ] **M2**: 6 new test spec files covering all v1.6 features
- [ ] **M3**: Test line count increases from 353 to ~1,900 lines
- [ ] **M4**: All tests pass in Chromium and WebKit browsers
- [ ] **M5**: Test execution time remains under 5 minutes (web mode)
- [ ] **M6**: Zero flaky tests (3 consecutive CI runs without failures)

## Rollback Plan

If tests are too flaky or execution time exceeds 10 minutes:
1. Disable flaky tests with `test.skip()` and file GitHub issues
2. Split test suite into "fast" and "slow" suites
3. Run slow tests only on PRs to main (not develop)

## Next Steps

After this plan completes:
- Execute Plan 17-02 (CI Integration & Cross-Platform Matrix)
- Monitor test execution time in CI
- Iterate on flaky tests based on CI failure patterns

---

*Plan created: 2026-02-11*  
*Phase 17, Plan 1 of 2*
