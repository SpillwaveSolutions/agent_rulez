# Plan 17-02: CI Integration & Cross-Platform Matrix

**Phase:** 17 - E2E Testing  
**Plan:** 17-02 of 2  
**Requirements:** E2E-03, E2E-02 (complete)  
**Depends on:** Plan 17-01  
**Estimated Duration:** 2-3 hours

## Goal

Ensure Playwright E2E test suite runs reliably in CI (GitHub Actions) on Ubuntu, macOS, and Windows with proper failure reporting, artifact collection, and test result publishing.

## Context

**Current CI State:**
- ✅ E2E tests run in `tauri-build.yml` (ubuntu-latest only, as gate for Tauri build)
- ✅ Playwright installed with chromium + webkit browsers
- ✅ Test reports uploaded as artifacts
- ❌ No cross-platform matrix (macOS, Windows)
- ❌ No test result publishing (GitHub checks UI)
- ❌ No failure screenshots/videos in CI artifacts
- ❌ No separate E2E workflow for PRs

**Existing CI Files:**
- `.github/workflows/tauri-build.yml` - Has E2E gate, runs on ubuntu-latest
- `.github/workflows/e2e.yml` - Standalone E2E workflow (ubuntu-latest only)
- `.github/workflows/e2e-matrix.yml` - Multi-platform matrix (exists but may be incomplete)
- `.github/workflows/e2e-windows.yml` - Windows-specific E2E workflow

**Gap Analysis:**
- ❌ E2E matrix workflow may not include all features from Plan 17-01
- ❌ No test result publishing to GitHub UI (PR checks)
- ❌ No screenshots/videos captured on failure
- ❌ No retry strategy for flaky tests
- ❌ No summary comment on PRs with test results

## Success Criteria

- [ ] **SC-01**: E2E tests pass in CI on ubuntu-latest, macos-latest, windows-latest
- [ ] **SC-02**: Test results published to GitHub checks UI with pass/fail status
- [ ] **SC-03**: Failure screenshots and videos uploaded as artifacts
- [ ] **SC-04**: Flaky tests automatically retried (2 retries on CI)
- [ ] **SC-05**: Test execution time under 5 minutes per platform
- [ ] **SC-06**: PR comments show test summary (X passed, Y failed, Z skipped)

## Implementation Plan

### Task 1: Update E2E Matrix Workflow (45 min)

**File:** `.github/workflows/e2e-matrix.yml`

**Changes:**

1. **Matrix Strategy:**
   ```yaml
   strategy:
     fail-fast: false
     matrix:
       os: [ubuntu-latest, macos-latest, windows-latest]
       browser: [chromium, webkit]
       exclude:
         # WebKit on Windows is not supported by Playwright
         - os: windows-latest
           browser: webkit
   ```

2. **Playwright Installation:**
   ```yaml
   - name: Install Playwright browsers
     run: bunx playwright install --with-deps ${{ matrix.browser }}
   ```

3. **Test Execution with Retries:**
   ```yaml
   - name: Run E2E tests
     run: bunx playwright test --project=${{ matrix.browser }}
     env:
       CI: true
   ```

4. **Artifact Upload (Conditional on Failure):**
   ```yaml
   - name: Upload screenshots
     uses: actions/upload-artifact@v4
     if: failure()
     with:
       name: playwright-screenshots-${{ matrix.os }}-${{ matrix.browser }}
       path: rulez-ui/test-results/**/*.png

   - name: Upload videos
     uses: actions/upload-artifact@v4
     if: failure()
     with:
       name: playwright-videos-${{ matrix.os }}-${{ matrix.browser }}
       path: rulez-ui/test-results/**/*.webm

   - name: Upload HTML report
     uses: actions/upload-artifact@v4
     if: always()
     with:
       name: playwright-report-${{ matrix.os }}-${{ matrix.browser }}
       path: rulez-ui/playwright-report/
       retention-days: 30
   ```

**Files:**
- `.github/workflows/e2e-matrix.yml` (modify ~60 lines)

### Task 2: Integrate Test Result Publishing (30 min)

**Use Action:** `dorny/test-reporter@v1`

**Add to E2E Matrix Workflow:**

```yaml
- name: Publish test results
  uses: dorny/test-reporter@v1
  if: always()
  with:
    name: Playwright Tests (${{ matrix.os }}, ${{ matrix.browser }})
    path: rulez-ui/test-results/junit.xml
    reporter: jest-junit
    fail-on-error: true
```

**Update Playwright Config:**

Ensure `playwright.config.ts` generates JUnit XML:

```typescript
reporter: process.env.CI
  ? [
      ["html", { outputFolder: "playwright-report" }],
      ["junit", { outputFile: "test-results/junit.xml" }], // ✓ Already exists
      ["github"],
    ]
  : [["html", { open: "never" }]],
```

**Files:**
- `.github/workflows/e2e-matrix.yml` (add test reporter step)
- `rulez-ui/playwright.config.ts` (verify JUnit reporter exists - no change needed)

### Task 3: Add PR Comment with Test Summary (40 min)

**Use Action:** `daun/playwright-report-comment@v3`

**Add to E2E Matrix Workflow:**

```yaml
- name: Comment test results on PR
  uses: daun/playwright-report-comment@v3
  if: github.event_name == 'pull_request'
  with:
    report-path: rulez-ui/playwright-report/
    comment-title: 'Playwright Test Results (${{ matrix.os }}, ${{ matrix.browser }})'
    include-summary: true
    include-report-link: true
```

**Benefits:**
- Shows pass/fail summary directly in PR
- Links to full HTML report artifact
- Auto-updates on re-run

**Files:**
- `.github/workflows/e2e-matrix.yml` (add PR comment step)

### Task 4: Configure Retry Strategy (15 min)

**Update Playwright Config:**

```typescript
// Retry on CI for flaky test detection
retries: process.env.CI ? 2 : 0,  // ✓ Already configured

// Limit workers on CI to avoid resource contention
workers: process.env.CI ? 1 : undefined,  // ✓ Already configured
```

**Verify Existing Config:**
- `playwright.config.ts` already has `retries: 2` on CI
- No changes needed, just document

**Files:**
- None (already configured correctly)

### Task 5: Optimize Test Execution Time (30 min)

**Current Bottlenecks:**
- Installing Playwright browsers (~1-2 min per platform)
- Running all tests sequentially

**Optimizations:**

1. **Cache Playwright Browsers:**
   ```yaml
   - name: Cache Playwright browsers
     uses: actions/cache@v4
     with:
       path: ~/.cache/ms-playwright
       key: playwright-${{ runner.os }}-${{ hashFiles('rulez-ui/package.json') }}
       restore-keys: |
         playwright-${{ runner.os }}-
   ```

2. **Parallel Test Execution (Already Configured):**
   ```typescript
   fullyParallel: true,  // ✓ Already enabled
   workers: process.env.CI ? 1 : undefined,  // Limit to 1 on CI to avoid flakiness
   ```

3. **Skip Slow Tests on CI (Optional):**
   - Tag slow tests with `test.slow()` or custom tags
   - Run only on PRs to main, not develop

**Files:**
- `.github/workflows/e2e-matrix.yml` (add browser cache step)

### Task 6: Update Tauri Build Workflow (20 min)

**File:** `.github/workflows/tauri-build.yml`

**Ensure Consistency:**
- E2E gate uses same test execution as `e2e-matrix.yml`
- Uses same retry strategy and artifact upload

**Changes:**

```yaml
test-e2e:
  name: E2E Tests (Web Mode)
  runs-on: ubuntu-latest
  steps:
    # ... existing steps ...

    - name: Run E2E tests
      run: bunx playwright test
      env:
        CI: true

    - name: Upload test results (always)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-tauri-gate
        path: rulez-ui/playwright-report/
        retention-days: 30

    - name: Upload failure artifacts
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-failures-tauri-gate
        path: |
          rulez-ui/test-results/**/*.png
          rulez-ui/test-results/**/*.webm
```

**Files:**
- `.github/workflows/tauri-build.yml` (update E2E gate)

### Task 7: Document CI Testing in README (15 min)

**Add Section to `rulez-ui/README.md`:**

```markdown
## CI Testing

E2E tests run automatically on:
- **PRs to develop**: Fast CI (ubuntu-latest, chromium + webkit) ~3-5 min
- **PRs to main**: Full matrix (ubuntu, macOS, Windows × chromium/webkit) ~15-20 min

### Test Reports

- HTML reports: Check "Artifacts" in GitHub Actions run
- Test summaries: Auto-posted as PR comments
- Failure artifacts: Screenshots and videos uploaded on test failures

### Running Locally

```bash
# Run all tests (mirrors CI)
CI=true bunx playwright test

# Run with retries (like CI)
bunx playwright test --retries=2

# Debug failing tests
bunx playwright test --debug
```

### Flaky Tests

Tests automatically retry 2 times on CI. If a test is consistently flaky:
1. Mark with `test.fixme()` and file an issue
2. Add `test.slow()` if timing-dependent
3. Increase explicit waits (avoid `waitForTimeout`)
```

**Files:**
- `rulez-ui/README.md` (add CI Testing section)

## File Changes

### Modified Files (4)
- `.github/workflows/e2e-matrix.yml` (~80 lines modified - add matrix, artifacts, reporters)
- `.github/workflows/tauri-build.yml` (~20 lines modified - improve E2E gate artifacts)
- `rulez-ui/README.md` (~30 lines added - document CI testing)
- `rulez-ui/playwright.config.ts` (~0 lines - verify existing config)

### No New Files
All changes are modifications to existing files.

## Testing Strategy

### Pre-Merge Validation
1. **Test locally first:**
   ```bash
   cd rulez-ui
   CI=true bunx playwright test --retries=2
   ```

2. **Verify artifacts generated:**
   - Check `test-results/junit.xml` exists
   - Check `playwright-report/` has HTML report

3. **Push to feature branch and verify CI:**
   - Confirm E2E matrix runs on all 3 platforms
   - Confirm test results appear in GitHub checks
   - Confirm PR comment shows test summary
   - Trigger a test failure and verify screenshots uploaded

### Matrix Validation

Test on all platforms:
- **ubuntu-latest**: chromium, webkit
- **macos-latest**: chromium, webkit
- **windows-latest**: chromium only (webkit unsupported)

**Expected Total:** 5 jobs (2+2+1)

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Flaky tests fail CI randomly | High | Retry strategy (2 retries), mark flaky tests with `.fixme()` |
| Windows Playwright setup issues | Medium | Use `--with-deps` flag, pre-install system dependencies |
| Test execution exceeds 10 min per platform | Medium | Cache browsers, run only critical tests on develop PRs |
| Artifact storage exceeds quota | Low | Set retention-days: 7 for screenshots, 30 for reports |

## Dependencies

**Blocking:**
- Plan 17-01 must complete (tests must exist before running in CI)

**Non-blocking:**
- Can set up CI infrastructure before tests are written (workflows will pass with existing tests)

## Success Metrics

- [ ] **M1**: E2E tests pass on all 3 platforms in CI (5 matrix jobs)
- [ ] **M2**: Test results visible in GitHub checks UI
- [ ] **M3**: PR comments show test summaries with pass/fail counts
- [ ] **M4**: Failure artifacts (screenshots, videos) uploaded on test failures
- [ ] **M5**: Test execution time <5 min per platform (ubuntu), <8 min (macOS/Windows)
- [ ] **M6**: Zero CI configuration errors (syntax, permissions, artifact paths)

## Rollback Plan

If CI becomes unstable:
1. Revert to single-platform (ubuntu-latest) E2E testing
2. Disable PR comments if they create spam
3. Run full matrix only on PRs to main (not develop)

## Next Steps

After this plan completes:
- Monitor CI stability for 1 week
- Address flaky tests by increasing waits or marking with `.fixme()`
- Consider splitting tests into fast/slow suites if execution time grows
- Phase 17 complete → Proceed to v1.6 release

---

*Plan created: 2026-02-11*  
*Phase 17, Plan 2 of 2*
