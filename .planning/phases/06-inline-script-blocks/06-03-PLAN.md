---
phase: 06-inline-script-blocks
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - rulez/src/hooks.rs
  - rulez/src/models.rs
  - rulez/src/config.rs
  - rulez/tests/inline_script_integration.rs
autonomous: true

must_haves:
  truths:
    - "Unit tests verify get_field() returns correct types for string, number, boolean, missing fields"
    - "Unit tests verify has_field() returns true for existing fields, false for missing/null"
    - "Unit tests verify validate_expr blocks when expression returns false"
    - "Unit tests verify validate_expr blocks on expression evaluation error (fail-closed)"
    - "Unit tests verify config rejects both validate_expr and inline_script on same rule"
    - "Unit tests verify config rejects invalid validate_expr syntax"
    - "Unit tests verify config rejects empty inline_script"
    - "Integration tests verify end-to-end validate_expr with custom functions"
    - "Integration tests verify end-to-end inline_script execution with stdin and exit codes"
    - "Integration tests verify inline_script timeout behavior (fail-closed)"
    - "Integration tests verify config validation errors at load time"
  artifacts:
    - path: "rulez/tests/inline_script_integration.rs"
      provides: "End-to-end integration tests for inline script blocks"
      min_lines: 400
    - path: "rulez/src/hooks.rs"
      provides: "Unit tests for custom functions and validate_expr evaluation"
      contains: "test_get_field"
    - path: "rulez/src/config.rs"
      provides: "Unit tests for config validation of validate_expr and inline_script"
      contains: "test_validate_expr"
  key_links:
    - from: "rulez/tests/inline_script_integration.rs"
      to: "rulez/src/hooks.rs"
      via: "Integration tests exercise process_event which calls validate_expr/inline_script logic"
      pattern: "process_event"
---

<objective>
Add comprehensive unit and integration tests for all SCRIPT-01 through SCRIPT-06 requirements, covering custom functions, expression evaluation, inline script execution, timeout protection, and config validation.

Purpose: Verify all inline script block functionality works correctly end-to-end and document behavior through tests. Tests provide requirement traceability for all six SCRIPT requirements.
Output: 30+ unit tests and 15+ integration tests covering all SCRIPT requirements with OQ test evidence.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-inline-script-blocks/06-RESEARCH.md
@.planning/phases/06-inline-script-blocks/06-01-SUMMARY.md
@.planning/phases/06-inline-script-blocks/06-02-SUMMARY.md

Key prior patterns:
- Phase 5 Plan 03 established unit test pattern: Event/Rule construction + direct function calls
- Phase 4/5 integration tests use temp dir + .claude/hooks.yaml + cargo_bin("rulez") + stdin event JSON
- Integration tests save evidence to target/test-evidence/ following OQ pattern
- Requirement traceability: test names include requirement ID (SCRIPT-01, etc.)
- All Actions struct instantiations need validate_expr: None, inline_script: None (from Plan 01)
- All Matchers struct instantiations follow existing pattern with require_fields: None, field_types: None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for custom functions, validate_expr evaluation, and config validation</name>
  <files>rulez/src/hooks.rs, rulez/src/config.rs, rulez/src/models.rs</files>
  <action>
Add unit tests to hooks.rs, config.rs, and models.rs covering the inline script block functionality.

**hooks.rs unit tests (at least 20 tests):**

*SCRIPT-01/02: Custom functions (8+ tests)*
- `test_get_field_string_value` — get_field("name") returns string for JSON string field
- `test_get_field_number_value` — get_field("count") returns float for JSON number field
- `test_get_field_boolean_value` — get_field("active") returns boolean for JSON bool field
- `test_get_field_missing_field` — get_field("nonexistent") returns empty string
- `test_get_field_null_field` — get_field("nullable") returns empty string for null value
- `test_get_field_nested_path` — get_field("user.name") returns nested field value
- `test_has_field_present` — has_field("name") returns true when field exists
- `test_has_field_missing` — has_field("nonexistent") returns false
- `test_has_field_null` — has_field("nullable") returns false for null values
- `test_has_field_nested` — has_field("user.name") returns true for nested field

*SCRIPT-03: Boolean return from validate_expr (5+ tests)*
- `test_validate_expr_returns_true_allows` — Expression `has_field("name")` with name present allows
- `test_validate_expr_returns_false_blocks` — Expression `has_field("missing")` blocks
- `test_validate_expr_comparison` — Expression `get_field("count") > 0` with count=5 allows
- `test_validate_expr_complex_expression` — Expression `has_field("name") && get_field("name") != ""` with name="test" allows
- `test_validate_expr_error_blocks` — Expression with syntax error blocks (fail-closed)

*SCRIPT-01: validate_expr in execute_rule_actions (4+ tests)*
- `test_validate_expr_blocks_before_inject` — validate_expr false prevents inject_inline from running
- `test_validate_expr_allows_then_injects` — validate_expr true allows inject_inline to proceed
- `test_validate_expr_no_tool_input_custom_functions` — get_field/has_field work when tool_input is None
- `test_validate_expr_with_env_vars` — Custom functions work alongside existing env_ variables in context

To test these, you'll need to construct Event and Rule objects directly and call the relevant functions. For execute_rule_actions tests, you can call the function directly since it's async — use `#[tokio::test]` for async tests.

If build_eval_context_with_custom_functions is private, either make it pub(crate) for testing or test it indirectly through the eval context.

**config.rs unit tests (at least 6 tests):**

*SCRIPT-06: Config validation (6+ tests)*
- `test_validate_expr_valid_syntax` — Valid expression passes validation
- `test_validate_expr_invalid_syntax` — Invalid expression (unclosed paren) fails validation with error message
- `test_inline_script_valid` — Non-empty script with shebang passes validation
- `test_inline_script_empty_rejected` — Empty/whitespace script fails validation
- `test_validate_expr_and_inline_script_mutual_exclusion` — Both present fails validation
- `test_validate_expr_only_passes` — Only validate_expr present passes validation

**models.rs unit tests (at least 2 tests):**

- `test_actions_validate_expr_deserialization` — YAML with validate_expr parses correctly
- `test_actions_inline_script_deserialization` — YAML with inline_script literal block parses correctly

Pattern for constructing test Actions:
```rust
actions: Actions {
    inject: None,
    inject_inline: None,
    inject_command: None,
    run: None,
    block: None,
    block_if_match: None,
    validate_expr: Some("has_field(\"name\")".to_string()),
    inline_script: None,
},
```
  </action>
  <verify>
`cd rulez && cargo test 2>&1 | tail -10` shows all tests pass including new ones. Count new tests: `cargo test 2>&1 | grep "test_get_field\|test_has_field\|test_validate_expr\|test_inline_script" | wc -l` shows 28+.
  </verify>
  <done>
At least 28 new unit tests covering: get_field/has_field custom functions, validate_expr boolean evaluation, validate_expr pipeline integration, config validation for syntax/empty/mutual exclusivity, and YAML deserialization. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add end-to-end integration tests for inline script blocks</name>
  <files>rulez/tests/inline_script_integration.rs</files>
  <action>
Create a new integration test file following the Phase 4/5 OQ pattern. Tests exercise the full stack: YAML config -> process_event -> response.

**Integration test structure** (follow field_validation_integration.rs pattern):
1. Create temp directory with `.claude/` subdirectory
2. Write YAML config to `.claude/hooks.yaml`
3. Construct JSON event string
4. Execute `cargo_bin("rulez")` with stdin event and temp dir as cwd
5. Assert on exit code and stdout content
6. Save test evidence to `target/test-evidence/`

**Tests to implement (at least 15):**

*SCRIPT-01: validate_expr in YAML (3 tests)*
- `test_e2e_validate_expr_passes_allows` — validate_expr `has_field("file_path")` with field present, verify injection occurs
- `test_e2e_validate_expr_fails_blocks` — validate_expr `has_field("missing")` blocks (exit code 2)
- `test_e2e_validate_expr_with_get_field` — validate_expr `get_field("language") == "rust"` with matching value allows

*SCRIPT-02: Custom functions (2 tests)*
- `test_e2e_get_field_nested` — validate_expr `get_field("user.name") != ""` with nested field present allows
- `test_e2e_has_field_with_null` — validate_expr `has_field("nullable")` with null value blocks (null = missing)

*SCRIPT-03: Boolean semantics (2 tests)*
- `test_e2e_validate_expr_complex_boolean` — validate_expr `has_field("name") && has_field("email")` with both present allows
- `test_e2e_validate_expr_false_expression` — validate_expr `1 == 2` always blocks

*SCRIPT-04: Inline shell scripts (3 tests)*
- `test_e2e_inline_script_exit_zero_allows` — Script `#!/bin/bash\nexit 0` allows
- `test_e2e_inline_script_exit_nonzero_blocks` — Script `#!/bin/bash\nexit 1` blocks
- `test_e2e_inline_script_reads_stdin` — Script reads event JSON from stdin, checks field, exit 0 if present

*SCRIPT-05: Timeout protection (1 test)*
- `test_e2e_inline_script_timeout_blocks` — Script `#!/bin/bash\nsleep 30` with timeout: 1 blocks (fail-closed)
  - Use rule metadata timeout: 1 (1 second) to trigger timeout quickly

*SCRIPT-06: Config validation (2 tests)*
- `test_e2e_invalid_validate_expr_rejected` — Config with `validate_expr: "((("` rejected at load time
- `test_e2e_mutual_exclusion_rejected` — Config with both validate_expr and inline_script rejected

*Combined tests (2 tests)*
- `test_e2e_validate_expr_with_tool_matcher` — validate_expr combined with tools matcher (both must match)
- `test_e2e_inline_script_with_inject_inline` — inline_script passes, inject_inline content appears in output

**Helper function:**
Create a test evidence helper (similar to field_validation_integration.rs):
```rust
fn save_test_evidence(test_name: &str, category: &str, passed: bool, details: &str) {
    // Write JSON to target/test-evidence/
}
```

**YAML config example for validate_expr:**
```yaml
version: "1.0"
rules:
  - name: test-validate
    matchers:
      tools: [Write]
    actions:
      validate_expr: 'has_field("file_path")'
      inject_inline: "Validation passed"
```

**YAML config example for inline_script:**
```yaml
version: "1.0"
rules:
  - name: test-script
    matchers:
      tools: [Bash]
    actions:
      inline_script: |
        #!/bin/bash
        exit 0
```

Note: For the timeout test, set metadata timeout to 1 second:
```yaml
    metadata:
      timeout: 1
```
  </action>
  <verify>
`cd rulez && cargo test --test inline_script_integration 2>&1 | tail -10` shows all 15+ tests pass. Test evidence files exist in `target/test-evidence/`.
  </verify>
  <done>
At least 15 integration tests covering all SCRIPT-01 through SCRIPT-06 requirements. Tests verify: validate_expr with custom functions (get_field, has_field), inline_script execution (exit codes, stdin), timeout protection (fail-closed), config validation (syntax, mutual exclusion), and combined scenarios. OQ test evidence saved.
  </done>
</task>

</tasks>

<verification>
1. `cd rulez && cargo test` — all tests pass (existing + new)
2. `cd rulez && cargo test --test inline_script_integration` — all integration tests pass
3. At least 28 new unit tests (hooks.rs, config.rs, models.rs)
4. At least 15 new integration tests (inline_script_integration.rs)
5. All SCRIPT requirements have test coverage:
   - SCRIPT-01: validate_expr in YAML (unit + integration)
   - SCRIPT-02: get_field/has_field functions (unit + integration)
   - SCRIPT-03: Boolean return semantics (unit + integration)
   - SCRIPT-04: Inline shell scripts (integration)
   - SCRIPT-05: Timeout protection (integration)
   - SCRIPT-06: Config validation (unit + integration)
6. Test evidence saved to target/test-evidence/
</verification>

<success_criteria>
- At least 43 new tests total (28+ unit, 15+ integration)
- All new tests pass with 100% success rate
- All existing tests pass (no regressions)
- Every SCRIPT requirement (01-06) has both unit and integration test coverage
- OQ test evidence generated and saved
- Test names include requirement traceability (SCRIPT-01, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/06-inline-script-blocks/06-03-SUMMARY.md`
</output>
