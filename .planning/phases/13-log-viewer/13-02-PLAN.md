# Phase 13 Plan 02: Log Viewer UI with Virtual Scrolling, Filtering, and Zustand Store

## Wave
Wave 1 (can execute in parallel with Plan 01 — uses mock data from `lib/tauri.ts`)

## Objective
Build the full log viewer UI: a Zustand store for log state, a main LogViewer component with `@tanstack/react-virtual` for 60fps virtual scrolling, filter bar (text search, severity dropdown, date range), and integrate it into the app layout as a main content view via a "Logs" navigation item.

## Why This Plan Exists
Satisfies success criteria:
- **SC-1** (view audit log entries in a scrollable list): LogViewer component with virtualized row rendering
- **SC-2** (filter by text, severity, time range): LogFilterBar with debounced text input, severity select, and date range pickers
- **SC-3** (100K+ entries at 60fps): `@tanstack/react-virtual` with fixed row height and overscan

## Tasks

### Task 1: Create Zustand log store and severity derivation
**File(s):**
- `rulez_ui/src/stores/logStore.ts` (NEW)

**Action:**
Create a Zustand store following the existing pattern in `configStore.ts` / `uiStore.ts`:

**State fields:**
- `entries: LogEntryDto[]` — current loaded log entries
- `filteredEntries: LogEntryDto[]` — entries after client-side text/severity filtering
- `totalCount: number` — total entries from stats
- `isLoading: boolean`
- `error: string | null`
- `textFilter: string` — text search input value
- `severityFilter: Severity | "all"` — "all" | "error" | "warn" | "info"
- `sinceFilter: string | null` — ISO date string for "from" date picker
- `untilFilter: string | null` — ISO date string for "to" date picker

**Actions:**
- `loadLogs(): Promise<void>` — calls `readLogs()` from `lib/tauri.ts` with current `sinceFilter`, `untilFilter` as params. Sets `entries` and `filteredEntries`. Sets `isLoading` during fetch. Catches errors and sets `error`.
- `setTextFilter(text: string): void` — updates `textFilter`, recomputes `filteredEntries` by filtering `entries` in JavaScript (case-insensitive search across `eventType`, `toolName`, `outcome`, `sessionId`, `rulesMatched.join()`, `responseReason`, `eventDetailCommand`, `eventDetailFilePath`)
- `setSeverityFilter(severity: Severity | "all"): void` — updates `severityFilter`, recomputes `filteredEntries` using `deriveSeverity()` function
- `setSinceFilter(since: string | null): void` — updates `sinceFilter`, triggers `loadLogs()` (server-side filter)
- `setUntilFilter(until: string | null): void` — updates `untilFilter`, triggers `loadLogs()` (server-side filter)
- `refreshLogs(): Promise<void>` — alias for `loadLogs()` to re-fetch from backend

**Implementation notes:**
- Text and severity filtering are done client-side on the already-loaded `entries` array (hybrid approach from research). This gives instant response on text/severity changes.
- Date range filtering triggers a full re-fetch from the Rust backend (server-side filter) since it changes the data set.
- The `filteredEntries` derivation function should be extracted as a helper for reuse.
- Import `LogEntryDto`, `LogQueryParams`, `Severity`, `deriveSeverity` from `@/types` and `readLogs` from `@/lib/tauri`.

**Acceptance:**
- `bun run typecheck` passes
- Store exports `useLogStore` with all state fields and actions
- `deriveSeverity` correctly maps: block→error, warned→warn, allow→info

### Task 2: Create LogViewer component with virtual scrolling
**File(s):**
- `rulez_ui/src/components/logs/LogViewer.tsx` (NEW)
- `rulez_ui/src/components/logs/LogEntryRow.tsx` (NEW)
- `rulez_ui/src/components/logs/LogFilterBar.tsx` (NEW)

**Action:**

**LogFilterBar.tsx:**
- Text search input: `<input type="text" placeholder="Search logs..." />` with 300ms debounce before calling `store.setTextFilter()`. Must match E2E POM selector: `getByPlaceholder(/search|filter/i)`.
- Severity dropdown: `<select>` (native HTML select, role="combobox") with options: All, Error, Warning, Info. Must match E2E POM: `getByRole("combobox", { name: /severity/i })`. Use `aria-label="Severity"`.
- Date range: two `<input type="date">` with labels "From" and "To" (matching E2E POM: `getByLabel(/from/i)` and `getByLabel(/to/i)`). On change, convert local date to UTC start/end of day and call `store.setSinceFilter()` / `store.setUntilFilter()`.
- Refresh button to call `store.refreshLogs()`.
- Show entry count: "{filteredEntries.length} entries" (or "{filteredEntries.length} of {entries.length}").
- Style with TailwindCSS: horizontal flex layout, gap-2, padding, dark mode support.

**LogEntryRow.tsx:**
- Receives `entry: LogEntryDto` and `style: React.CSSProperties` props
- Renders a single row with: timestamp (formatted as `HH:mm:ss.SSS`), severity badge (colored: red for error, yellow for warn, blue for info), event type, tool name, outcome, short summary (rules matched count or response reason)
- Must have `data-testid="log-entry"` on the row container
- Must have a copy button with `aria-label="Copy"` (matching E2E POM: `getByRole("button", { name: /copy/i })`). The copy button calls the store's `copyEntry()` action (to be wired in Plan 03). For now, add an `onCopy?: (entry: LogEntryDto) => void` prop.
- Severity badge colors: error = `bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200`, warn = `bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200`, info = `bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200`
- Fixed row height of 36px to match virtualizer `estimateSize`
- Style: `position: absolute`, uses `transform: translateY(...)` from virtualizer

**LogViewer.tsx:**
- Main container component that composes LogFilterBar + virtualized log list
- Uses `useLogStore` to get `filteredEntries`, `isLoading`, `error`
- Calls `store.loadLogs()` on mount via `useEffect`
- Creates a `useVirtualizer` from `@tanstack/react-virtual`:
  ```tsx
  const rowVirtualizer = useVirtualizer({
    count: filteredEntries.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 36,
    overscan: 20,
  });
  ```
- Renders:
  1. LogFilterBar at top
  2. A scroll container `div` with `ref={parentRef}` and `overflow-y: auto`, `flex: 1`
  3. Inside: a positioning div with `height: rowVirtualizer.getTotalSize()px`, `position: relative`
  4. Maps `rowVirtualizer.getVirtualItems()` to `<LogEntryRow>` components with proper `style` and `key`
- Shows loading spinner when `isLoading`
- Shows error message when `error`
- Shows empty state ("No log entries found") when `filteredEntries.length === 0` and not loading
- Shows "Log file not found" message if stats indicate 0 entries and no file

**Acceptance:**
- All three component files exist and export their components
- `bun run typecheck` passes
- `bun run build` succeeds
- Components use `data-testid="log-entry"` for E2E compatibility

### Task 3: Integrate LogViewer into app layout as a main content view
**File(s):**
- `rulez_ui/src/stores/uiStore.ts`
- `rulez_ui/src/components/layout/MainContent.tsx`
- `rulez_ui/src/components/layout/Header.tsx`

**Action:**

1. **Update `uiStore.ts`:**
   - Add `"logs"` to `RightPanelTab` type — but actually, the log viewer should be a **main content view**, not a right panel tab (it needs full width for the table). Instead, add a new state field:
     ```typescript
     export type MainView = "editor" | "logs";
     ```
   - Add `mainView: MainView` to state (default: `"editor"`)
   - Add `setMainView: (view: MainView) => void` action
   - Keep `RightPanelTab` unchanged

2. **Update `MainContent.tsx`:**
   - Import `LogViewer` from `@/components/logs/LogViewer`
   - Import `useUIStore` to get `mainView`
   - When `mainView === "logs"`, render `<LogViewer />` instead of the editor area
   - When `mainView === "editor"`, render the existing editor content (unchanged)
   - The LogViewer takes full width/height of the main content area

3. **Update `Header.tsx`:**
   - Add a "Logs" button/nav item next to the existing controls that calls `setMainView("logs")`
   - The button must match the E2E POM selector: `getByRole("button", { name: /log viewer|logs/i })`
   - Use `aria-label="Logs"` or visible text "Logs"
   - Visually indicate active view (highlight Logs button when `mainView === "logs"`)
   - Also add an "Editor" button/item for switching back (or make the RuleZ UI logo/title clickable to return to editor)

**Acceptance:**
- `bun run typecheck` passes
- Clicking "Logs" button in header switches main content to LogViewer
- Clicking "Editor" (or equivalent) switches back to YAML editor
- Log viewer takes full width of main content area
- `bun run build` succeeds

## Verification
1. `cd rulez_ui && bun run typecheck` — TypeScript compiles
2. `cd rulez_ui && bun run build` — Full build succeeds
3. Manual: `bun run dev` in browser → click "Logs" → see log viewer with mock data
4. Manual: Type in search box → entries filter after 300ms debounce
5. Manual: Change severity dropdown → entries filter immediately
6. Manual: Scroll through entries → smooth scrolling, no jank (virtual rendering)
7. E2E selectors match: `data-testid="log-entry"`, search placeholder, severity combobox, from/to labels

## Dependencies
- Phase 12 must be complete (it is — ✅)
- `@tanstack/react-virtual` must be installed (Task 1 of Plan 01 installs it, OR this plan can install it independently if running in parallel — check `package.json` and run `bun add @tanstack/react-virtual` if missing)
- **No dependency on Plan 01's Rust commands** — this plan uses mock data from `lib/tauri.ts` for the UI. Real Tauri integration is verified in Plan 03.
