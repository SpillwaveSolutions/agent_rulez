# Phase 13 Plan 03: Export, Clipboard Copy, and Integration Verification

## Wave
Wave 2 (depends on Plan 01 and Plan 02 — requires both Rust commands and UI components)

## Objective
Add JSON/CSV export via Tauri native save dialog, clipboard copy for individual log entries, wire the copy button in LogEntryRow to the Tauri clipboard plugin, and verify the full end-to-end integration works: Rust backend → Tauri IPC → LogViewer UI with all filters and actions functional.

## Why This Plan Exists
Satisfies success criteria:
- **SC-4** (export filtered log results to JSON or CSV): Export menu with native save dialog and file write
- **SC-5** (copy individual log entries to clipboard): Copy button on each row using Tauri clipboard plugin
- **Integration verification**: Ensures Plans 01 and 02 work together end-to-end

## Tasks

### Task 1: Add export functionality (JSON + CSV) with Tauri native dialog
**File(s):**
- `rulez_ui/src/components/logs/LogExportMenu.tsx` (NEW)
- `rulez_ui/src/components/logs/LogViewer.tsx` (MODIFY)
- `rulez_ui/src/lib/log-utils.ts` (NEW or add to existing)

**Action:**

1. **Create `lib/log-utils.ts`** with export utilities:
   - `entriesToJson(entries: LogEntryDto[]): string` — `JSON.stringify(entries, null, 2)`
   - `entriesToCsv(entries: LogEntryDto[]): string` — Manual CSV generation (~20 lines, no library needed):
     - Headers: `timestamp,event_type,tool_name,outcome,decision,mode,rules_matched,processing_ms,session_id,response_reason`
     - Escape fields containing commas, quotes, or newlines (wrap in double quotes, escape internal quotes by doubling)
     - Join rows with `\n`
   - `deriveSeverity(entry: LogEntryDto): Severity` — move here from types if not already. Keep re-export from types for backward compat.

2. **Create `LogExportMenu.tsx`:**
   - Renders an "Export" button matching E2E POM: `getByRole("button", { name: /export/i })`
   - On click, shows a dropdown/menu with two options:
     - "Export as JSON" — `getByRole("menuitem", { name: /json/i })`
     - "Export as CSV" — `getByRole("menuitem", { name: /csv/i })`
   - Use a simple state toggle for the dropdown (open/close). Use `<div role="menu">` and `<button role="menuitem">` for accessibility.
   - Close dropdown on outside click or after selection.
   - On format selection:
     - Get `filteredEntries` from `useLogStore`
     - Generate content string using `entriesToJson()` or `entriesToCsv()`
     - If in Tauri mode (`isTauri()`):
       - Import `save` from `@tauri-apps/plugin-dialog`
       - Import `writeTextFile` from `@tauri-apps/plugin-fs`
       - Call `save({ filters: [{ name: format, extensions: [ext] }], defaultPath: 'rulez-logs.' + ext })`
       - If user selects a path, call `writeTextFile(path, content)`
     - If in browser mode (testing):
       - Create a Blob, generate object URL, trigger download via temporary anchor element
       - This provides a working export even in web test mode
   - Show brief "Exported!" success feedback (e.g., update status bar or show inline message for 2 seconds)

3. **Integrate into LogViewer.tsx:**
   - Import `LogExportMenu`
   - Place it in the LogFilterBar area or as a separate toolbar row — near the filter controls
   - Alternatively, add the export button directly into `LogFilterBar.tsx` if that's cleaner

**Acceptance:**
- Export button appears in the log viewer
- Clicking "Export as JSON" opens native save dialog (in Tauri) or triggers download (in browser)
- Clicking "Export as CSV" does the same for CSV format
- Exported JSON is valid JSON containing the filtered entries
- Exported CSV has proper headers and escaped fields
- `bun run typecheck` passes

### Task 2: Wire clipboard copy to LogEntryRow
**File(s):**
- `rulez_ui/src/stores/logStore.ts` (MODIFY)
- `rulez_ui/src/components/logs/LogEntryRow.tsx` (MODIFY)
- `rulez_ui/src/components/logs/LogViewer.tsx` (MODIFY)

**Action:**

1. **Add `copyEntry` action to logStore:**
   ```typescript
   copyEntry: async (entry: LogEntryDto) => {
     const text = JSON.stringify(entry, null, 2);
     if (isTauri()) {
       const { writeText } = await import("@tauri-apps/plugin-clipboard-manager");
       await writeText(text);
     } else {
       await navigator.clipboard.writeText(text);
     }
   }
   ```

2. **Wire the copy button in LogEntryRow.tsx:**
   - The copy button already exists from Plan 02 with an `onCopy` prop
   - In `LogViewer.tsx`, pass `onCopy={store.copyEntry}` (or `onCopy={(entry) => useLogStore.getState().copyEntry(entry)}`) to each `LogEntryRow`
   - On successful copy, briefly show visual feedback on the button (e.g., change icon to a checkmark for 1 second, or change button text to "Copied!")

3. **Visual feedback pattern:**
   - Use local state in LogEntryRow: `const [copied, setCopied] = useState(false)`
   - On copy click: call `onCopy(entry)`, set `copied = true`, `setTimeout(() => setCopied(false), 1500)`
   - When `copied`: show checkmark icon and/or "Copied!" text instead of "Copy"

**Acceptance:**
- Click copy button on any log entry → entry JSON is copied to clipboard
- Visual "Copied!" feedback appears briefly
- Works in both Tauri mode (clipboard plugin) and browser mode (navigator.clipboard)
- `bun run typecheck` passes

### Task 3: End-to-end integration verification and cleanup
**File(s):**
- `rulez_ui/tests/fixtures/mock-logs.json` (MODIFY — update to match real LogEntry format)
- Various files for minor fixes

**Action:**

1. **Update E2E mock data** (`tests/fixtures/mock-logs.json`):
   - Replace the existing wrong-format entries (`{level, message, source}`) with entries matching the real `LogEntryDto` format
   - Include at least 10 entries with varied outcomes (allow, block, inject), decisions (allowed, blocked, warned), event types (PreToolUse, PostToolUse, SessionStart), and tools (Bash, Write, Edit, Read)
   - This ensures E2E tests can run against realistic mock data

2. **Verify full integration** (manual testing checklist):
   - [ ] App builds: `cd rulez_ui && bun run build` succeeds
   - [ ] TypeScript: `bun run typecheck` passes
   - [ ] Lint: `bun run lint` passes (fix any biome issues)
   - [ ] In browser dev mode (`bun run dev`):
     - Click "Logs" in header → LogViewer appears with mock data
     - Type in search → entries filter with debounce
     - Change severity dropdown → entries filter
     - Set date range → entries re-fetch (with mock)
     - Click Export → JSON/CSV → download works
     - Click Copy on entry → clipboard contains entry JSON
     - Scroll through entries → smooth virtual scrolling
     - Click "Editor" → return to YAML editor
   - [ ] E2E selectors present:
     - `data-testid="log-entry"` on each row
     - Search input matches `/search|filter/i` placeholder
     - Severity select matches `combobox` with `/severity/i`
     - Export button matches `/export/i`
     - Copy button matches `/copy/i`
     - From/To date inputs with correct labels

3. **Minor cleanup:**
   - Ensure no TypeScript `any` types leaked into the log viewer code
   - Ensure dark mode works for all log viewer components
   - Ensure the LogViewer properly cleans up (no memory leaks from subscriptions or intervals)
   - Add brief JSDoc comments to exported functions in `logStore.ts` and `lib/log-utils.ts`

**Acceptance:**
- `bun run build` succeeds
- `bun run typecheck` passes
- `bun run lint` passes
- All E2E POM selectors from `log-viewer.page.ts` have matching elements in the DOM
- Mock log data matches the real LogEntry format
- Full log viewer workflow functions in browser dev mode

## Verification
1. `cd rulez_ui && bun run typecheck && bun run build && bun run lint` — all pass
2. Manual in browser: complete workflow test (open logs, filter, search, export, copy, scroll, switch back to editor)
3. E2E selector audit: each selector in `tests/pages/log-viewer.page.ts` has a matching DOM element
4. If a real `~/.claude/logs/rulez.log` file exists and Tauri dev mode works: `bun run dev:tauri` and verify real log data renders

## Dependencies
- **Plan 01 must be complete**: Rust commands (`read_logs`, `get_log_stats`) and Tauri plugin registrations
- **Plan 02 must be complete**: LogViewer UI, logStore, LogEntryRow, LogFilterBar, layout integration
- Both plans are Wave 1; this plan is Wave 2
