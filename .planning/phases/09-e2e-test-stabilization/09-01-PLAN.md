---
phase: 09-e2e-test-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rulez/tests/common/mod.rs
  - rulez/tests/e2e_git_push_block.rs
autonomous: true

must_haves:
  truths:
    - "canonicalize_path() resolves macOS /var -> /private/var symlinks for tempdir paths"
    - "canonicalize_path() falls back to the original path when canonicalization fails (e.g., path does not exist yet)"
    - "All E2E tests use canonical paths in event JSON cwd field"
    - "CWD-based config loading tests work even when macOS symlinks differ from canonical paths"
    - "All 631+ existing tests continue to pass unchanged"
    - "E2E tests use .output() (not .spawn() + .wait()), which is safe from broken pipe issues (REQ-E2E-03 verified)"
  artifacts:
    - path: "rulez/tests/common/mod.rs"
      provides: "canonicalize_path() helper function for cross-platform path resolution"
      contains: "canonicalize_path"
    - path: "rulez/tests/e2e_git_push_block.rs"
      provides: "Updated E2E tests using canonical paths in event setup"
      contains: "canonicalize_path"
  key_links:
    - from: "rulez/tests/e2e_git_push_block.rs"
      to: "rulez/tests/common/mod.rs"
      via: "setup_claude_code_event() calls canonicalize_path() on tempdir path"
      pattern: "canonicalize_path"
    - from: "rulez/tests/common/mod.rs"
      to: "std::fs::canonicalize"
      via: "canonicalize_path() wraps fs::canonicalize() with fallback"
      pattern: "fs::canonicalize"
---

<objective>
Add a canonicalize_path() helper to tests/common/mod.rs and update all E2E tests to use canonical paths in event JSON setup, fixing macOS /var symlink path mismatches.

Purpose: On macOS, tempfile::tempdir() returns paths like /var/folders/... but fs::canonicalize() resolves to /private/var/folders/... because /var is a symlink. If the event JSON cwd uses the non-canonical path but RuleZ internally canonicalizes, config loading may fail to match. This plan ensures all E2E tests use canonical paths consistently.

Output: Updated tests/common/mod.rs with canonicalize_path(), updated e2e_git_push_block.rs using canonical paths, all existing tests still pass.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-test-stabilization/09-RESEARCH.md

Key files to read before implementing:
@rulez/tests/common/mod.rs — Shared test utilities (setup_test_env, fixtures_dir, evidence_dir, Timer, TestEvidence)
@rulez/tests/e2e_git_push_block.rs — 8 E2E tests using setup_claude_code_event() with tempdir paths
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add canonicalize_path() helper to tests/common/mod.rs</name>
  <files>rulez/tests/common/mod.rs</files>
  <action>
Add a `canonicalize_path()` function to `rulez/tests/common/mod.rs`:

```rust
/// Canonicalize a path to resolve symlinks (e.g., macOS /var -> /private/var).
///
/// On macOS, `tempfile::tempdir()` returns paths like `/var/folders/...`
/// but `/var` is a symlink to `/private/var`. This helper ensures paths
/// used in event JSON match what the binary sees after resolution.
///
/// Falls back to the original path if canonicalization fails (e.g., path
/// does not exist yet).
pub fn canonicalize_path<P: AsRef<Path>>(path: P) -> PathBuf {
    fs::canonicalize(path.as_ref())
        .unwrap_or_else(|_| path.as_ref().to_path_buf())
}
```

Place it after the `setup_test_env()` function and before the `Timer` struct.

Note: `std::fs` and `std::path::{Path, PathBuf}` are already imported in this file.
  </action>
  <verify>
Run: `cargo build --tests --workspace` to verify compilation.
  </verify>
  <done>
- canonicalize_path() helper exists in tests/common/mod.rs
- It resolves symlinks via fs::canonicalize()
- It falls back to original path on error
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Update setup_claude_code_event() to use canonical paths</name>
  <files>rulez/tests/e2e_git_push_block.rs</files>
  <action>
1. Update the import line to include `canonicalize_path`:
```rust
use common::{CchResponse, TestEvidence, Timer, canonicalize_path, evidence_dir, fixture_path, setup_test_env};
```

2. Update `setup_claude_code_event()` to canonicalize the temp dir path before using it in the event JSON:

**BEFORE:**
```rust
fn setup_claude_code_event(config_name: &str, command: &str) -> (tempfile::TempDir, String) {
    let temp_dir = setup_test_env(config_name);
    let cwd = temp_dir.path().to_string_lossy().to_string();
```

**AFTER:**
```rust
fn setup_claude_code_event(config_name: &str, command: &str) -> (tempfile::TempDir, String) {
    let temp_dir = setup_test_env(config_name);
    let canonical_path = canonicalize_path(temp_dir.path());
    let cwd = canonical_path.to_string_lossy().to_string();
```

3. Update `test_e2e_no_config_allows_all()` (Test 7) which creates its own event JSON without using `setup_claude_code_event()`:

**BEFORE:**
```rust
let empty_dir = tempfile::tempdir().expect("create empty dir");
let cwd = empty_dir.path().to_string_lossy().to_string();
```

**AFTER:**
```rust
let empty_dir = tempfile::tempdir().expect("create empty dir");
let cwd = canonicalize_path(empty_dir.path()).to_string_lossy().to_string();
```
  </action>
  <verify>
Run:
- `cargo test --workspace -- test_e2e` — all 8 E2E tests pass
- `cargo test --tests --all-features --workspace` — full suite passes (631+ tests)
- `cargo clippy --all-targets --all-features --workspace -- -D warnings` — no warnings
  </verify>
  <done>
- setup_claude_code_event() uses canonicalize_path() for tempdir paths
- test_e2e_no_config_allows_all() also uses canonical paths
- All 8 E2E tests pass
- All existing tests pass unchanged
  </done>
</task>

</tasks>

<verification>
1. `cargo fmt --all --check` — no formatting issues
2. `cargo clippy --all-targets --all-features --workspace -- -D warnings` — no warnings
3. `cargo test --tests --all-features --workspace` — all 631+ tests pass
4. `cargo llvm-cov --all-features --workspace --no-report` — coverage run passes
5. Verify on macOS: E2E tests produce canonical paths in event JSON (no /var/folders without /private prefix)
</verification>

<success_criteria>
- canonicalize_path() helper exists and resolves symlinks
- All E2E tests use canonical paths in event JSON cwd field
- All 631+ existing tests continue to pass
- E2E tests verified safe from broken pipe (all use .output(), REQ-E2E-03)
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-stabilization/09-01-SUMMARY.md`
</output>
