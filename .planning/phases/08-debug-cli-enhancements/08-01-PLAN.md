---
phase: 08-debug-cli-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rulez/src/cli/debug.rs
  - rulez/src/main.rs
  - rulez/tests/iq_new_commands.rs
autonomous: true

must_haves:
  truths:
    - "User runs `rulez debug prompt --prompt 'test text'` and sees event processed with matching rules"
    - "User sees which rules matched, actions taken, and timing info in debug output"
    - "UserPromptSubmit events go through the same process_event() pipeline as real hook events"
    - "REGEX_CACHE is cleared at start of debug run() so each invocation has clean state"
  artifacts:
    - path: "rulez/src/cli/debug.rs"
      provides: "SimEventType::UserPromptSubmit variant, build_event prompt support, REGEX_CACHE clearing, enhanced output"
      contains: "UserPromptSubmit"
    - path: "rulez/src/main.rs"
      provides: "--prompt CLI flag in Debug command"
      contains: "prompt"
    - path: "rulez/tests/iq_new_commands.rs"
      provides: "Integration tests for debug prompt command"
      contains: "test_debug_prompt"
  key_links:
    - from: "rulez/src/main.rs"
      to: "rulez/src/cli/debug.rs"
      via: "Commands::Debug prompt field passed to cli::debug::run()"
      pattern: "cli::debug::run.*prompt"
    - from: "rulez/src/cli/debug.rs"
      to: "rulez/src/hooks.rs"
      via: "process_event() called with Event containing prompt field"
      pattern: "hooks::process_event"
    - from: "rulez/src/cli/debug.rs"
      to: "rulez/src/hooks.rs"
      via: "REGEX_CACHE.lock().unwrap().clear() at start of run()"
      pattern: "REGEX_CACHE.*clear"
---

<objective>
Add UserPromptSubmit event type to the debug CLI, add --prompt flag, clear REGEX_CACHE for state isolation, and enhance debug output with matched rules, actions, and timing info.

Purpose: Users currently cannot test prompt_match rules via the debug CLI because UserPromptSubmit is missing from SimEventType. This closes that testing gap and improves debug output quality.
Output: Updated debug.rs, main.rs, and integration tests.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files to read before implementing:
@rulez/src/cli/debug.rs — Current debug CLI (SimEventType, build_event, run)
@rulez/src/main.rs — CLI arg parsing (Commands::Debug)
@rulez/src/hooks.rs — REGEX_CACHE global, process_event()
@rulez/src/models.rs — Event struct (has prompt: Option<String>), EventType enum (has UserPromptSubmit)
@rulez/tests/iq_new_commands.rs — Existing debug CLI integration tests
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UserPromptSubmit to SimEventType and --prompt flag</name>
  <files>rulez/src/cli/debug.rs, rulez/src/main.rs</files>
  <action>
**In `rulez/src/main.rs`:**

1. Add `--prompt` flag to the `Commands::Debug` variant:
```rust
/// User prompt text (for UserPromptSubmit events)
#[arg(long)]
prompt: Option<String>,
```

2. Pass `prompt` to `cli::debug::run()` in the match arm:
```rust
cli::debug::run(event_type, tool, command, path, prompt, verbose).await?;
```

**In `rulez/src/cli/debug.rs`:**

1. Add `UserPromptSubmit` variant to `SimEventType` enum.

2. Add aliases in `SimEventType::from_str()`:
```rust
"userpromptsubmit" | "prompt" | "user-prompt" | "user-prompt-submit" => Some(SimEventType::UserPromptSubmit),
```

3. Add mapping in `as_model_event_type()`:
```rust
SimEventType::UserPromptSubmit => ModelEventType::UserPromptSubmit,
```

4. Update the error message in `run()` to include UserPromptSubmit in valid types list.

5. Update `run()` function signature to accept `prompt: Option<String>`.

6. Add REGEX_CACHE clearing at the START of `run()` (before any processing):
```rust
// Clear regex cache for state isolation between debug invocations
{
    use crate::hooks::REGEX_CACHE;
    REGEX_CACHE.lock().unwrap().clear();
}
```
NOTE: This requires making `REGEX_CACHE` public in hooks.rs. Add `pub` to the `static REGEX_CACHE` declaration.

7. Update `build_event()` to accept `prompt: Option<String>` parameter and set `event.prompt = prompt` in the Event struct. For UserPromptSubmit events, if no `--tool` is specified, `tool_name` should be `None` (not defaulting to "Bash"), and `tool_input` should be `None`.

8. Enhance debug output in `run()` AFTER processing:
   - Show timing info: `"Processed in {N}ms ({M} rules evaluated)"`
   - Show matched rules with their actions (iterate response to extract from timing field)
   - Use the existing `response.timing` field which process_event() already populates
   - Show a "Rules Matched" section listing rule names and their action modes
   - Example enhanced output:
     ```
     Performance:
     ----------------------------------------
     Processed in 2ms (5 rules evaluated)
     ```

9. Update the `interactive()` function to pass `None` for the new `prompt` parameter in all its calls to `run()`.
  </action>
  <verify>
Run `cargo build --workspace` to verify compilation. Then:
- `cargo test --workspace -- test_debug` to run existing debug tests (they should still pass with the new prompt parameter)
- Run `cargo clippy --all-targets --all-features --workspace -- -D warnings` to verify no warnings
  </verify>
  <done>
- SimEventType has UserPromptSubmit variant with 4 aliases
- Commands::Debug has --prompt flag
- run() clears REGEX_CACHE before processing
- build_event() correctly constructs UserPromptSubmit events with prompt text
- Enhanced output shows timing info
- All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for debug prompt command</name>
  <files>rulez/tests/iq_new_commands.rs</files>
  <action>
Add new integration tests to `rulez/tests/iq_new_commands.rs` in a new section after the existing debug tests:

1. **`test_debug_prompt_event`** — Tests `rulez debug prompt --prompt "deploy to production"` with a hooks.yaml that has a prompt_match rule. Verify:
   - Exit code 0
   - Output contains "UserPromptSubmit" (event type)
   - Output contains "deploy to production" (the prompt text)
   - Output contains "Processed in" (timing info)

2. **`test_debug_prompt_alias_user_prompt`** — Tests `rulez debug user-prompt --prompt "test"` (alias). Verify exit code 0 and output contains "UserPromptSubmit".

3. **`test_debug_prompt_without_prompt_flag`** — Tests `rulez debug prompt` (no --prompt flag). Verify exit code 0 (should still work, prompt is None).

4. **`test_debug_prompt_matching_rule`** — Create a hooks.yaml with a prompt_match rule that matches "deploy" and has inject_inline action. Run `rulez debug prompt --prompt "deploy to production"`. Verify output contains "Allowed with injected context" (rule matched and injected).

Each test should:
- Create a TempDir
- Run `rulez init` to create base config
- Optionally write a custom hooks.yaml for prompt_match rules
- Run the debug command and assert on output

Use the existing test patterns (cch_cmd(), TempDir, assert_cmd) from the file.

The hooks.yaml for prompt_match tests should look like:
```yaml
rules:
  - name: deploy-guard
    description: "Guard deploy prompts"
    event_types: [UserPromptSubmit]
    matchers:
      prompt_match: ["deploy"]
    actions:
      inject_inline: "CAUTION: Deploy detected"
```
  </action>
  <verify>
Run: `cargo test --workspace -- test_debug_prompt` — all 4 new tests pass.
Run: `cargo test --workspace -- test_debug` — all existing + new debug tests pass.
  </verify>
  <done>
- 4 new integration tests exercise the debug prompt command
- Tests cover: basic prompt event, alias, missing flag, and matching rule
- All tests pass alongside existing debug tests
  </done>
</task>

</tasks>

<verification>
1. `cargo fmt --all --check` — no formatting issues
2. `cargo clippy --all-targets --all-features --workspace -- -D warnings` — no warnings
3. `cargo test --tests --all-features --workspace` — all tests pass
4. `cargo llvm-cov --all-features --workspace --no-report` — coverage run passes (catches pipe/process bugs)
5. Manual verification: `rulez debug prompt --prompt "test"` produces clean output with timing info
</verification>

<success_criteria>
- `rulez debug prompt --prompt "test text"` processes a UserPromptSubmit event successfully
- Debug output shows timing info ("Processed in Xms")
- REGEX_CACHE is cleared at start of each debug invocation
- All 4 new integration tests pass
- All existing tests continue to pass
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/08-debug-cli-enhancements/08-01-SUMMARY.md`
</output>
