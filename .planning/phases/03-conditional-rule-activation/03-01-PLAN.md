---
phase: 03-conditional-rule-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rulez/Cargo.toml
  - rulez/src/models.rs
autonomous: true

must_haves:
  truths:
    - "evalexpr crate is added to Cargo.toml dependencies"
    - "enabled_when field parses from YAML configuration"
    - "Rule struct includes enabled_when: Option<String>"
    - "Unit tests verify YAML parsing and expression syntax"
  artifacts:
    - path: "rulez/Cargo.toml"
      provides: "evalexpr dependency declaration"
      contains: "evalexpr"
    - path: "rulez/src/models.rs"
      provides: "enabled_when field in Rule struct"
      contains: "enabled_when: Option<String>"
  key_links:
    - from: "rulez/Cargo.toml"
      to: "evalexpr crate"
      via: "dependency declaration"
      pattern: 'evalexpr.*"13'
---

<objective>
Add the evalexpr dependency and enabled_when field to the Rule struct.

Purpose: Enable conditional rule activation by parsing enabled_when expressions from YAML configuration. This is the foundation for Phase 3 expression evaluation.

Output: Rule struct with enabled_when field, evalexpr crate available, unit tests for YAML parsing.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-conditional-rule-activation/03-RESEARCH.md
@rulez/src/models.rs
@rulez/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add evalexpr dependency to Cargo.toml</name>
  <files>rulez/Cargo.toml</files>
  <action>
Add the evalexpr crate to rulez/Cargo.toml dependencies section:

1. Open rulez/Cargo.toml
2. In the [dependencies] section, add:
   ```toml
   evalexpr = "13.1"
   ```
3. Place it alphabetically among the other dependencies

The evalexpr crate provides:
- Expression parsing with `build_operator_tree`
- Boolean evaluation with `eval_boolean_with_context`
- HashMapContext for variable binding
- EvalexprError for validation
  </action>
  <verify>
```bash
cd /Users/richardhightower/clients/spillwave/src/rulez_plugin/rulez && cargo build 2>&1 | tail -20
```
Build succeeds with evalexpr downloaded and compiled.
  </verify>
  <done>
evalexpr = "13.1" added to Cargo.toml dependencies, cargo build downloads and compiles the crate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add enabled_when field to Rule struct and unit tests</name>
  <files>rulez/src/models.rs</files>
  <action>
Add `enabled_when: Option<String>` field to the Rule struct in models.rs:

1. In models.rs, add to Rule struct (after description and before matchers):
```rust
    /// Condition expression that must be true for rule to be active
    /// Evaluated against context variables: env_*, tool_name, event_type
    /// Uses evalexpr syntax. Example: `env_CI == "true"`
    #[serde(skip_serializing_if = "Option::is_none")]
    pub enabled_when: Option<String>,
```

2. Update ALL Rule struct instantiations in tests to include `enabled_when: None`

3. Add unit tests for enabled_when YAML parsing:
- test_enabled_when_yaml_parsing
- test_enabled_when_with_logical_operators
- test_enabled_when_none_by_default
- test_enabled_when_full_rule_yaml
- test_evalexpr_basic_expression
  </action>
  <verify>
```bash
cd /Users/richardhightower/clients/spillwave/src/rulez_plugin/rulez && cargo test --lib -- test_enabled_when --nocapture 2>&1
```
All enabled_when tests pass.
  </verify>
  <done>
- enabled_when field added to Rule struct with serde attributes
- All test Rule instantiations updated with enabled_when: None
- 5 new unit tests for YAML parsing pass
- evalexpr basic expression test passes
  </done>
</task>

</tasks>

<verification>
Run all tests to verify no regressions:
```bash
cd /Users/richardhightower/clients/spillwave/src/rulez_plugin/rulez && cargo test 2>&1
```
Expected: All tests pass (200+), build succeeds, no warnings.
</verification>

<success_criteria>
- evalexpr = "13.1" in Cargo.toml dependencies
- enabled_when field exists in Rule struct with proper serde attributes
- All test Rule instantiations updated
- 5 new unit tests pass for YAML parsing
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-conditional-rule-activation/03-01-SUMMARY.md`
</output>
