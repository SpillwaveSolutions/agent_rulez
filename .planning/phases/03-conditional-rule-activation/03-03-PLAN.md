---
phase: 03-conditional-rule-activation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - rulez/src/config.rs
  - rulez/tests/oq_us3_enabled_when.rs
autonomous: true

must_haves:
  truths:
    - "Config.validate() checks enabled_when expression syntax"
    - "Invalid expressions produce clear error messages with rule name"
    - "rulez validate command reports expression syntax errors"
    - "Integration tests verify full enabled_when workflow"
  artifacts:
    - path: "rulez/src/config.rs"
      provides: "Expression validation in validate() method"
      contains: "build_operator_tree"
    - path: "rulez/tests/oq_us3_enabled_when.rs"
      provides: "Integration tests for enabled_when"
      contains: "enabled_when"
  key_links:
    - from: "rulez/src/config.rs"
      to: "evalexpr"
      via: "build_operator_tree for validation"
      pattern: "build_operator_tree"
---

<objective>
Add expression validation to config loading and create integration tests.

Purpose: Ensure invalid enabled_when expressions are caught at config load time with clear error messages, and verify the complete enabled_when workflow works end-to-end.

Output: Validation in config.rs, integration tests.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-conditional-rule-activation/03-RESEARCH.md
@.planning/phases/03-conditional-rule-activation/03-01-SUMMARY.md
@rulez/src/config.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expression validation to Config.validate()</name>
  <files>rulez/src/config.rs</files>
  <action>
Add enabled_when expression validation to config.rs:

1. Add evalexpr import at the top of config.rs:
```rust
use evalexpr::build_operator_tree;
```

2. In Config::validate() method, add expression validation after rule name validation:
```rust
            // Validate enabled_when expression syntax
            if let Some(ref expr) = rule.enabled_when {
                build_operator_tree(expr).with_context(|| {
                    format!(
                        "Invalid enabled_when expression '{}' in rule '{}': syntax error",
                        expr, rule.name
                    )
                })?;
            }
```

3. Add 3 unit tests for expression validation:
- test_enabled_when_valid_expression
- test_enabled_when_invalid_expression
- test_enabled_when_complex_valid_expression

4. Update any existing test Rule instantiations in config.rs to include `enabled_when: None`
  </action>
  <verify>
```bash
cd /Users/richardhightower/clients/spillwave/src/rulez_plugin/rulez && cargo test --lib -- test_enabled_when --nocapture 2>&1
```
All enabled_when validation tests pass.
  </verify>
  <done>
- evalexpr::build_operator_tree used for expression validation
- Invalid expressions produce clear errors with rule name and expression
- 3 unit tests verify valid/invalid/complex expressions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for enabled_when</name>
  <files>rulez/tests/oq_us3_enabled_when.rs</files>
  <action>
Create integration test file rulez/tests/oq_us3_enabled_when.rs:

Tests to include:
- test_enabled_when_true_rule_active - Rule with true condition blocks
- test_enabled_when_false_rule_skipped - Rule with false condition is skipped
- test_enabled_when_tool_name_condition - tool_name context works
- test_validate_invalid_enabled_when - CLI validation catches errors
- test_enabled_when_logical_operators - && expressions work

Use assert_cmd::Command and predicates crate for assertions.
Create temp directory with .claude/hooks.yaml for each test.
  </action>
  <verify>
```bash
cd /Users/richardhightower/clients/spillwave/src/rulez_plugin/rulez && cargo test --test oq_us3_enabled_when --nocapture 2>&1
```
All 5 integration tests pass.
  </verify>
  <done>
- Integration test file created at rulez/tests/oq_us3_enabled_when.rs
- 5 integration tests verify end-to-end workflow
  </done>
</task>

</tasks>

<verification>
Run all tests to verify complete Phase 3 implementation:
```bash
cd /Users/richardhightower/clients/spillwave/src/rulez_plugin/rulez && cargo test 2>&1
```
Expected: All tests pass (215+), build succeeds.
</verification>

<success_criteria>
- Config.validate() catches invalid enabled_when expressions
- Error messages include rule name and expression text
- rulez validate command reports expression errors
- 5 integration tests verify end-to-end workflow
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-conditional-rule-activation/03-03-SUMMARY.md`
</output>
