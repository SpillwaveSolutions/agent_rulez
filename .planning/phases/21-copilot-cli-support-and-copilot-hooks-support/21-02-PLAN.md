---
phase: 21-copilot-cli-support-and-copilot-hooks-support
plan: 02
type: execute
wave: 2
depends_on:
  - 21-01
files_modified:
  - cch_cli/src/cli/copilot_hook.rs
  - cch_cli/src/cli.rs
  - cch_cli/src/main.rs
  - cch_cli/tests/copilot_hook_runner.rs
autonomous: true

must_haves:
  truths:
    - "Copilot hooks can invoke `cch copilot hook` and receive JSON-only output."
    - "Hook runner returns allow with reason on parse/eval errors instead of crashing."
  artifacts:
    - path: "cch_cli/src/cli/copilot_hook.rs"
      provides: "Copilot hook runner (stdin -> JSON response)"
    - path: "cch_cli/tests/copilot_hook_runner.rs"
      provides: "Hook runner integration tests"
  key_links:
    - from: "cch_cli/src/cli/copilot_hook.rs"
      to: "cch_cli/src/adapters/copilot.rs"
      via: "parse_event + translate_response"
      pattern: "adapters::copilot"
    - from: "cch_cli/src/main.rs"
      to: "cch_cli/src/cli/copilot_hook.rs"
      via: "Copilot subcommand dispatch"
      pattern: "CopilotSubcommand::Hook"
---

<objective>
Add a Copilot hook runner subcommand that reads stdin JSON and emits Copilot hook responses.

Purpose: Provide the executable entrypoint Copilot hooks call for policy enforcement.
Output: `cch copilot hook` runner and integration tests.
</objective>

<execution_context>
@/Users/richardhightower/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-copilot-cli-support-and-copilot-hooks-support/21-RESEARCH.md
@.planning/phases/20-gemini-cli-support-and-gemini-hooks-support/20-03-SUMMARY.md
@cch_cli/src/cli/gemini_hook.rs
@cch_cli/src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement `cch copilot hook` runner</name>
  <files>
    cch_cli/src/cli/copilot_hook.rs
    cch_cli/src/cli.rs
    cch_cli/src/main.rs
  </files>
  <action>
    Add a Copilot hook runner that mirrors Gemini hook runner safety and JSON output discipline.
    - Implement copilot_hook::run(debug_logs) to read stdin, parse JSON, and use adapters::copilot::parse_event.
    - Load config using the event cwd (same pattern as gemini_hook.rs) and process_event via hooks::process_event.
    - Translate Response into CopilotHookResponse using adapters::copilot::translate_response.
    - On any error, emit a safe Allow response with a reason to stdout and log the error to stderr.
    - Ensure stdout is JSON-only with no extra text.
    - Wire new Copilot subcommand in main.rs and module export in cli.rs.
  </action>
  <verify>cargo test -p cch copilot_hook_runner</verify>
  <done>`cch copilot hook` reads stdin JSON and emits a single-line Copilot JSON response.</done>
</task>

<task type="auto">
  <name>Task 2: Add copilot hook runner tests</name>
  <files>
    cch_cli/tests/copilot_hook_runner.rs
  </files>
  <action>
    Add integration tests for the hook runner similar to gemini_hook_runner.rs.
    - Test allow response for a valid preToolUse payload.
    - Test deny response when a blocking rule is enforced (fixture rule config).
    - Assert stdout is valid JSON and contains permissionDecision fields only.
  </action>
  <verify>cargo test -p cch copilot_hook_runner</verify>
  <done>Hook runner tests validate allow/deny output and JSON-only stdout.</done>
</task>

</tasks>

<verification>
- `cargo test -p cch copilot_hook_runner`
</verification>

<success_criteria>
- Copilot hook runner processes stdin payloads and outputs Copilot JSON responses.
- Errors return allow+reason without crashing the CLI.
- Integration tests cover allow/deny paths.
</success_criteria>

<output>
After completion, create `.planning/phases/21-copilot-cli-support-and-copilot-hooks-support/21-02-SUMMARY.md`
</output>
