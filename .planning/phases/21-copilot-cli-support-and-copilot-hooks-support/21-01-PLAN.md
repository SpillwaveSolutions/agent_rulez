---
phase: 21-copilot-cli-support-and-copilot-hooks-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cch_cli/src/adapters/copilot.rs
  - cch_cli/src/adapters/mod.rs
  - cch_cli/src/models.rs
  - cch_cli/tests/copilot_adapter.rs
autonomous: true

must_haves:
  truths:
    - "Copilot hook payloads map to the intended RuleZ EventType values."
    - "Copilot tool events preserve the original hook name in tool_input."
    - "RuleZ allow/deny responses translate into Copilot permission decisions."
  artifacts:
    - path: "cch_cli/src/adapters/copilot.rs"
      provides: "Copilot hook input normalization and response translation"
    - path: "cch_cli/src/models.rs"
      provides: "Copilot hook response types"
      contains: "CopilotHookResponse"
    - path: "cch_cli/tests/copilot_adapter.rs"
      provides: "Copilot adapter mapping/translation tests"
  key_links:
    - from: "cch_cli/src/adapters/copilot.rs"
      to: "cch_cli/src/models.rs"
      via: "CopilotHookResponse + CopilotDecision"
      pattern: "CopilotHookResponse"
    - from: "cch_cli/src/adapters/copilot.rs"
      to: "cch_cli/src/models.rs"
      via: "EventType mapping"
      pattern: "EventType::"
---

<objective>
Normalize Copilot hook payloads into RuleZ events and translate RuleZ decisions into Copilot hook JSON responses.

Purpose: Enable policy enforcement for Copilot CLI/agent hooks with correct event semantics and decision output.
Output: Copilot adapter, response types, and adapter tests.
</objective>

<execution_context>
@/Users/richardhightower/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/21-copilot-cli-support-and-copilot-hooks-support/21-RESEARCH.md
@.planning/phases/20-gemini-cli-support-and-gemini-hooks-support/20-01-SUMMARY.md
@cch_cli/src/adapters/gemini.rs
@cch_cli/src/models.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Copilot hook input normalization</name>
  <files>
    cch_cli/src/adapters/copilot.rs
    cch_cli/src/adapters/mod.rs
  </files>
  <action>
    Create a Copilot adapter that parses the Copilot hook JSON payload into RuleZ Event values.
    - Define a CopilotHookInput struct that captures required fields (session_id, hook_event_name, timestamp, tool_name, tool_input, cwd, user_id, and any extra fields).
    - Map Copilot hook names to EventType:
      preToolUse -> PreToolUse (tool event)
      postToolUse -> PostToolUse (tool event)
      promptSubmit -> UserPromptSubmit
      sessionStart -> SessionStart
      sessionEnd -> SessionEnd
      error -> Notification (preserve name)
      unknown -> Notification (preserve name)
    - Merge extra fields into tool_input, preserving the original hook name in tool_input as copilot_hook_event_name when mapping differs or is unknown.
    - Return a CopilotEvent struct containing the original hook_event_name, the normalized Event, and a boolean for tool events.
    - Export the new adapter module in cch_cli/src/adapters/mod.rs.
  </action>
  <verify>cargo test -p cch copilot_adapter</verify>
  <done>Copilot hook payloads parse into RuleZ Event with preserved hook name in tool_input for tool or unknown events.</done>
</task>

<task type="auto">
  <name>Task 2: Translate RuleZ responses to Copilot JSON + tests</name>
  <files>
    cch_cli/src/adapters/copilot.rs
    cch_cli/src/models.rs
    cch_cli/tests/copilot_adapter.rs
  </files>
  <action>
    Add Copilot response types to models and implement translation from RuleZ Response.
    - Define CopilotDecision enum (Allow/Deny) and CopilotHookResponse struct with fields:
      permissionDecision, permissionDecisionReason, and optional tool_input overrides if the Copilot hook schema supports it.
    - Implement translate_response(response, copilot_event) to produce Allow/Deny and include reason when blocking.
    - For tool events, do not emit any Claude Code-specific continue flag (Copilot schema does not use it).
    - Add copilot_adapter tests mirroring Gemini adapter coverage:
      mapping tool event -> PreToolUse with hook name preserved
      mapping promptSubmit -> UserPromptSubmit with prompt fields preserved
      translate allow/deny into permissionDecision values
  </action>
  <verify>cargo test -p cch copilot_adapter</verify>
  <done>Copilot response translation produces valid permissionDecision output and adapter tests cover mappings.</done>
</task>

</tasks>

<verification>
- `cargo test -p cch copilot_adapter`
</verification>

<success_criteria>
- Copilot hook payloads normalize into RuleZ EventType with original hook names preserved in tool_input when needed.
- RuleZ allow/deny decisions translate into Copilot JSON responses with permissionDecision and reason.
- Adapter tests validate mapping and response semantics.
</success_criteria>

<output>
After completion, create `.planning/phases/21-copilot-cli-support-and-copilot-hooks-support/21-01-SUMMARY.md`
</output>
