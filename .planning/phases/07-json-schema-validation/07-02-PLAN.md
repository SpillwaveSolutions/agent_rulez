---
phase: 07-json-schema-validation
plan: 02
type: tdd
wave: 2
depends_on: ["07-01"]
files_modified:
  - rulez/src/schema.rs
  - rulez/tests/schema_validation_integration.rs
autonomous: true

must_haves:
  truths:
    - "Unit tests confirm schema generation produces valid JSON Schema with required Event fields"
    - "Unit tests confirm valid events pass schema validation without warnings"
    - "Unit tests confirm structurally invalid events trigger warning log but return successfully (fail-open)"
    - "Integration tests confirm malformed JSON on stdin produces exit code 1"
    - "Integration tests confirm valid events on stdin process end-to-end without errors"
    - "Integration tests confirm structurally invalid events log warning but still produce output (fail-open)"
    - "Binary size is verified to remain under 5MB"
  artifacts:
    - path: "rulez/src/schema.rs"
      provides: "Unit tests for schema generation and validation"
      contains: "#[cfg(test)]"
    - path: "rulez/tests/schema_validation_integration.rs"
      provides: "Integration tests for schema validation via CLI"
      contains: "cargo_bin"
  key_links:
    - from: "rulez/tests/schema_validation_integration.rs"
      to: "rulez/src/main.rs"
      via: "CLI binary invocation with piped stdin"
      pattern: "cargo_bin.*rulez"
    - from: "rulez/src/schema.rs"
      to: "rulez/src/models.rs"
      via: "generate_event_schema uses Event type"
      pattern: "schema_for.*Event"
---

<objective>
Add comprehensive tests for JSON Schema validation: unit tests for schema generation and validation logic, integration tests for CLI behavior with malformed/invalid/valid JSON, and binary size verification.

Purpose: Verify all schema validation requirements (REQ-SCHEMA-01 through REQ-SCHEMA-06, REQ-PERF-02) are met with automated tests that catch regressions.

Output: Unit tests in schema.rs, integration tests in schema_validation_integration.rs.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-json-schema-validation/07-01-SUMMARY.md
@rulez/src/schema.rs
@rulez/src/main.rs
@rulez/src/models.rs
@rulez/tests/common/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for schema generation and validation</name>
  <files>rulez/src/schema.rs</files>
  <action>
Add a `#[cfg(test)]` module at the bottom of `schema.rs` with the following tests:

**Test 1: `test_generate_event_schema_is_valid_json_schema`**
- Call `generate_event_schema()` and verify:
  - Result is a JSON object with `"$schema"` key (schemars 1.2 uses 2020-12 draft)
  - Has `"type": "object"` at top level
  - Has `"properties"` object
  - Properties include `"hook_event_name"` and `"session_id"` (the two required fields)
  - Has `"required"` array containing `"hook_event_name"` and `"session_id"`

**Test 2: `test_validate_valid_event_passes`**
- Create a valid event JSON value:
```json
{
  "hook_event_name": "PreToolUse",
  "session_id": "test-123",
  "tool_name": "Bash",
  "tool_input": {"command": "ls"},
  "cwd": "/tmp"
}
```
- Call `validate_event_schema(&value)`
- Verify no panic (function returns () -- it always succeeds in fail-open mode)
- This test confirms the happy path works

**Test 3: `test_validate_missing_required_fields_warns_but_succeeds`**
- Create JSON missing required fields: `{"tool_name": "Bash"}`
- Call `validate_event_schema(&value)`
- Verify function returns without panic (fail-open)
- Note: Cannot easily assert on tracing::warn output in unit tests. The fact that the function returns is sufficient to verify fail-open. Integration tests will verify the full behavior.

**Test 4: `test_validate_wrong_type_warns_but_succeeds`**
- Create JSON with wrong types: `{"hook_event_name": 42, "session_id": true}`
- Call `validate_event_schema(&value)`
- Verify function returns without panic (fail-open)

**Test 5: `test_validate_empty_object_warns_but_succeeds`**
- Create empty JSON object: `{}`
- Call `validate_event_schema(&value)`
- Verify function returns without panic (fail-open)

**Test 6: `test_validate_extra_fields_accepted`**
- Create JSON with all required fields PLUS unknown extra fields:
```json
{
  "hook_event_name": "PreToolUse",
  "session_id": "test-123",
  "unknown_field": "should be accepted"
}
```
- Call `validate_event_schema(&value)`
- Verify no warnings (schemars does NOT generate `additionalProperties: false` unless `#[serde(deny_unknown_fields)]` is present, and Event does not have that attribute)

**Test 7: `test_schema_contains_event_type_enum_variants`**
- Call `generate_event_schema()` and verify the schema for `hook_event_name` includes EventType enum variants (PreToolUse, PostToolUse, etc.)
- Check the generated schema has `$defs` or inline enum definition for EventType

Use `serde_json::json!()` macro for constructing test values. Import from crate: `use super::*;`
  </action>
  <verify>
Run `cargo test --lib -p rulez -- schema` to verify all unit tests pass.
  </verify>
  <done>
- 7+ unit tests in schema.rs covering: schema generation validity, valid events pass, invalid events fail-open, wrong types fail-open, empty objects fail-open, extra fields accepted, EventType enum variants in schema
- All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for CLI schema validation behavior and binary size check</name>
  <files>rulez/tests/schema_validation_integration.rs</files>
  <action>
Create `rulez/tests/schema_validation_integration.rs` with integration tests that exercise schema validation through the full CLI binary.

**Setup:** Follow existing integration test patterns (see `rulez/tests/oq_us1_blocking.rs`). Use:
- `assert_cmd::Command` with `cargo_bin("rulez")`
- `tempfile::TempDir` for test config directories
- `predicates::prelude::*` for assertions
- Write a minimal valid `hooks.yaml` to temp dir's `.claude/hooks.yaml` for each test

Create a helper function `create_test_config(temp_dir: &TempDir)` that writes a minimal hooks.yaml:
```yaml
version: "1.0"
rules: []
settings:
  fail_open: true
```

**Test 1: `test_malformed_json_exits_code_1` (REQ-SCHEMA-05)**
- Pipe `{"invalid json` (not valid JSON) to rulez binary stdin
- Set CWD to temp dir with valid config
- Assert exit code is 1 (not 0, not 2)
- Assert stderr contains error message about JSON parsing

**Test 2: `test_empty_stdin_exits_code_1`**
- Pipe empty string to rulez binary stdin
- Assert exit code is 1
- Assert stderr contains "No input received"

**Test 3: `test_valid_event_processes_successfully`**
- Pipe valid event JSON to rulez binary stdin:
```json
{"hook_event_name":"PreToolUse","session_id":"test-123","tool_name":"Bash","tool_input":{"command":"echo hello"},"cwd":"<TEMP_DIR>"}
```
- Set CWD to temp dir with valid config (rules: [] so nothing matches)
- Assert exit code is 0
- Assert stdout contains `"continue":true` (allowed response)

**Test 4: `test_structurally_invalid_event_continues_processing` (REQ-SCHEMA-04)**
- Pipe valid JSON but with missing required fields: `{"tool_name":"Bash"}`
- This is valid JSON but fails schema validation AND will fail Event deserialization
- The schema validation is fail-open (logs warning), but the subsequent `serde_json::from_value::<Event>` will fail because `hook_event_name` and `session_id` are required by serde
- Assert the binary handles this gracefully (exit code 1 from deserialization error, not exit code 2)

**Test 5: `test_event_with_extra_fields_accepted`**
- Pipe event JSON with all required fields plus unknown extra fields:
```json
{"hook_event_name":"PreToolUse","session_id":"test-123","extra_unknown_field":"should be fine","cwd":"<TEMP_DIR>"}
```
- Assert exit code is 0 (extra fields don't cause errors because Event uses default serde behavior which ignores unknown fields)

**Test 6: `test_binary_size_under_5mb` (REQ-PERF-02)**
- Use `std::fs::metadata` to check the release binary size
- Build path: check `target/release/rulez` if it exists, otherwise skip test with a message
- Assert file size < 5 * 1024 * 1024 (5MB)
- Mark this test with `#[ignore]` annotation since it requires a release build. Document: "Run with `cargo test --release -- --ignored test_binary_size_under_5mb`"

**Test 7: `test_event_with_wrong_types_continues_processing` (REQ-SCHEMA-04)**
- Pipe JSON where `hook_event_name` is an integer instead of string: `{"hook_event_name":42,"session_id":"test-123"}`
- Schema validation will warn (fail-open), then serde deserialization will fail
- Assert exit code is not 2 (not a policy block)

Follow existing test patterns:
- Use `Command::cargo_bin("rulez").unwrap()` for the binary
- Use `.write_stdin(json_string)` to pipe stdin
- Use `.current_dir(temp_dir.path())` or set env vars for config resolution
- Use `.assert().code(expected_code)` for exit code checks
- Use `.assert().stderr(predicate)` for error message checks
  </action>
  <verify>
Run `cargo test --tests -p rulez -- schema_validation` to verify all integration tests pass.
Run the full test suite: `cargo test --tests --all-features --workspace` to ensure no regressions.
Run `cargo clippy --all-targets --all-features --workspace -- -D warnings` for lint check.
Run `cargo fmt --all --check` for formatting.
  </verify>
  <done>
- 7 integration tests in schema_validation_integration.rs
- Tests cover: malformed JSON (exit 1), empty stdin (exit 1), valid event (exit 0), structurally invalid (fail-open), extra fields accepted, wrong types (fail-open), binary size check
- All existing tests still pass (no regressions)
- Clippy and fmt pass
  </done>
</task>

</tasks>

<verification>
1. `cargo test --lib -p rulez -- schema` passes (unit tests)
2. `cargo test --tests -p rulez -- schema_validation` passes (integration tests)
3. `cargo test --tests --all-features --workspace` passes (full suite, no regressions)
4. `cargo clippy --all-targets --all-features --workspace -- -D warnings` clean
5. `cargo fmt --all --check` clean
6. `cargo llvm-cov --all-features --workspace --no-report` passes (coverage run catches pipe/process bugs)
</verification>

<success_criteria>
- 7+ unit tests verify schema generation and fail-open validation
- 7 integration tests verify CLI behavior for all JSON scenarios
- Binary size check test exists (ignored by default, requires release build)
- All 605+ existing tests pass with no regressions
- Full CI pipeline passes locally (fmt, clippy, test, coverage)
</success_criteria>

<output>
After completion, create `.planning/phases/07-json-schema-validation/07-02-SUMMARY.md`
</output>
