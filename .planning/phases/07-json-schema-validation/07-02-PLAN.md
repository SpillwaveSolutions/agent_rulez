---
phase: 07-json-schema-validation
plan: 02
type: tdd
wave: 2
depends_on: ["07-01"]
files_modified:
  - rulez/src/schema.rs
  - rulez/tests/schema_validation_integration.rs
autonomous: true

must_haves:
  truths:
    - "Unit tests confirm schema generation produces valid JSON Schema 2020-12 with required Event fields"
    - "Unit tests confirm schema_draft_version() returns the 2020-12 draft URI (REQ-SCHEMA-06)"
    - "Unit tests confirm valid events pass schema validation without warnings"
    - "Unit tests confirm events with schema deviations trigger warning log but return successfully (fail-open)"
    - "Integration tests confirm malformed JSON on stdin produces exit code 1"
    - "Integration tests confirm valid events on stdin process end-to-end without errors"
    - "Integration tests confirm events missing required serde fields fail with non-zero exit (fail-closed deserialization, distinct from fail-open schema validation)"
    - "Integration tests confirm events with extra fields pass both schema validation and deserialization"
    - "Integration test verifies event processing completes within 100ms wall clock (REQ-PERF-01)"
    - "Binary size is verified to remain under 5MB"
  artifacts:
    - path: "rulez/src/schema.rs"
      provides: "Unit tests for schema generation, validation, and draft version"
      contains: "#[cfg(test)]"
    - path: "rulez/tests/schema_validation_integration.rs"
      provides: "Integration tests for schema validation via CLI and performance"
      contains: "cargo_bin"
  key_links:
    - from: "rulez/tests/schema_validation_integration.rs"
      to: "rulez/src/main.rs"
      via: "CLI binary invocation with piped stdin"
      pattern: "cargo_bin.*rulez"
    - from: "rulez/src/schema.rs"
      to: "rulez/src/models.rs"
      via: "generate_event_schema uses Event type"
      pattern: "schema_for.*Event"
---

<objective>
Add comprehensive tests for JSON Schema validation: unit tests for schema generation, validation logic, and draft version query; integration tests for CLI behavior with malformed/invalid/valid JSON; performance timing assertion; and binary size verification.

Purpose: Verify all schema validation requirements (REQ-SCHEMA-01 through REQ-SCHEMA-06, REQ-PERF-01, REQ-PERF-02) are met with automated tests that catch regressions. Explicitly distinguishes fail-open schema validation from fail-closed serde deserialization.

Output: Unit tests in schema.rs, integration tests in schema_validation_integration.rs.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-json-schema-validation/07-01-SUMMARY.md
@rulez/src/schema.rs
@rulez/src/main.rs
@rulez/src/models.rs
@rulez/tests/common/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for schema generation, validation, and draft version</name>
  <files>rulez/src/schema.rs</files>
  <action>
Add a `#[cfg(test)]` module at the bottom of `schema.rs` with the following tests:

**Test 1: `test_generate_event_schema_is_valid_json_schema`**
- Call `generate_event_schema()` and verify:
  - Result is a JSON object with `"$schema"` key (schemars 1.2 uses 2020-12 draft)
  - Has `"type": "object"` at top level
  - Has `"properties"` object
  - Properties include `"hook_event_name"` and `"session_id"` (the two required fields)
  - Has `"required"` array containing `"hook_event_name"` and `"session_id"`

**Test 2: `test_schema_draft_version_is_2020_12` (REQ-SCHEMA-06)**
- Call `schema_draft_version()` and verify it returns `"https://json-schema.org/draft/2020-12/schema"`
- Call `generate_event_schema()` and verify the `"$schema"` field in the generated schema matches the value returned by `schema_draft_version()`
- This test ensures that the documented draft version matches what schemars actually generates

**Test 3: `test_validate_valid_event_passes`**
- Create a valid event JSON value:
```json
{
  "hook_event_name": "PreToolUse",
  "session_id": "test-123",
  "tool_name": "Bash",
  "tool_input": {"command": "ls"},
  "cwd": "/tmp"
}
```
- Call `validate_event_schema(&value)`
- Verify no panic (function returns () -- it always succeeds in fail-open mode)
- This test confirms the happy path works

**Test 4: `test_validate_missing_required_fields_warns_but_returns` (fail-open schema validation)**
- Create JSON missing required fields: `{"tool_name": "Bash"}`
- Call `validate_event_schema(&value)`
- Verify function returns without panic (fail-open)
- Note: Cannot easily assert on tracing::warn output in unit tests. The fact that the function returns is sufficient to verify fail-open. Integration tests will verify the full behavior.

**Test 5: `test_validate_wrong_type_warns_but_returns`**
- Create JSON with wrong types: `{"hook_event_name": 42, "session_id": true}`
- Call `validate_event_schema(&value)`
- Verify function returns without panic (fail-open)

**Test 6: `test_validate_empty_object_warns_but_returns`**
- Create empty JSON object: `{}`
- Call `validate_event_schema(&value)`
- Verify function returns without panic (fail-open)

**Test 7: `test_validate_extra_fields_accepted`**
- Create JSON with all required fields PLUS unknown extra fields:
```json
{
  "hook_event_name": "PreToolUse",
  "session_id": "test-123",
  "unknown_field": "should be accepted"
}
```
- Call `validate_event_schema(&value)`
- Verify no warnings (schemars does NOT generate `additionalProperties: false` unless `#[serde(deny_unknown_fields)]` is present, and Event does not have that attribute)

**Test 8: `test_schema_contains_event_type_enum_variants`**
- Call `generate_event_schema()` and verify the schema for `hook_event_name` includes EventType enum variants (PreToolUse, PostToolUse, etc.)
- Check the generated schema has `$defs` or inline enum definition for EventType

Use `serde_json::json!()` macro for constructing test values. Import from crate: `use super::*;`
  </action>
  <verify>
Run `cargo test --lib -p rulez -- schema` to verify all unit tests pass.
  </verify>
  <done>
- 8 unit tests in schema.rs covering: schema generation validity, draft version 2020-12 (REQ-SCHEMA-06), valid events pass, missing fields fail-open, wrong types fail-open, empty objects fail-open, extra fields accepted, EventType enum variants in schema
- All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for CLI schema validation behavior, performance, and binary size</name>
  <files>rulez/tests/schema_validation_integration.rs</files>
  <action>
Create `rulez/tests/schema_validation_integration.rs` with integration tests that exercise schema validation through the full CLI binary.

**Setup:** Follow existing integration test patterns (see `rulez/tests/oq_us1_blocking.rs`). Use:
- `assert_cmd::Command` with `cargo_bin("rulez")`
- `tempfile::TempDir` for test config directories
- `predicates::prelude::*` for assertions
- Write a minimal valid `hooks.yaml` to temp dir's `.claude/hooks.yaml` for each test

Create a helper function `create_test_config(temp_dir: &TempDir)` that writes a minimal hooks.yaml:
```yaml
version: "1.0"
rules: []
settings:
  fail_open: true
```

**Test 1: `test_malformed_json_exits_code_1` (REQ-SCHEMA-05)**
- Pipe `{"invalid json` (not valid JSON) to rulez binary stdin
- Set CWD to temp dir with valid config
- Assert exit code is 1 (not 0, not 2)
- Assert stderr contains error message about JSON parsing

**Test 2: `test_empty_stdin_exits_code_1`**
- Pipe empty string to rulez binary stdin
- Assert exit code is 1
- Assert stderr contains "No input received"

**Test 3: `test_valid_event_processes_successfully`**
- Pipe valid event JSON to rulez binary stdin:
```json
{"hook_event_name":"PreToolUse","session_id":"test-123","tool_name":"Bash","tool_input":{"command":"echo hello"},"cwd":"<TEMP_DIR>"}
```
- Set CWD to temp dir with valid config (rules: [] so nothing matches)
- Assert exit code is 0
- Assert stdout contains `"continue":true` (allowed response)

**Test 4: `test_missing_required_fields_fails_deserialization` (Blocker 2/3 fix)**
- Pipe valid JSON but with missing required serde fields: `{"tool_name":"Bash"}`
- This is valid JSON, so JSON parsing (step 1) succeeds.
- Schema validation (step 2) is fail-open: logs warning for missing hook_event_name/session_id, returns.
- Serde deserialization (step 3) FAILS because hook_event_name and session_id are required by the Event struct. This is fail-closed -- the error propagates via `?` and main() exits non-zero.
- Assert exit code is NOT 0 (deserialization error) and NOT 2 (policy block).
- Assert stderr contains "deserialize" error message.
- **Important:** This test name accurately reflects behavior: deserialization fails, it does NOT "continue processing". The previous test name `test_structurally_invalid_event_continues_processing` was misleading because fail-open only applies to schema validation, not serde deserialization.

**Test 5: `test_event_with_extra_fields_accepted`**
- Pipe event JSON with all required fields plus unknown extra fields:
```json
{"hook_event_name":"PreToolUse","session_id":"test-123","extra_unknown_field":"should be fine","cwd":"<TEMP_DIR>"}
```
- Assert exit code is 0 (extra fields don't cause errors because Event uses default serde behavior which ignores unknown fields, and schema validation is fail-open for additionalProperties)

**Test 6: `test_binary_size_under_5mb` (REQ-PERF-02)**
- Use `std::fs::metadata` to check the release binary size
- Build path: check `target/release/rulez` if it exists, otherwise skip test with a message
- Assert file size < 5 * 1024 * 1024 (5MB)
- Mark this test with `#[ignore]` annotation since it requires a release build. Document: "Run with `cargo test --release -- --ignored test_binary_size_under_5mb`"

**Test 7: `test_event_with_wrong_types_fails_deserialization`**
- Pipe JSON where `hook_event_name` is an integer instead of string: `{"hook_event_name":42,"session_id":"test-123"}`
- Schema validation will warn (fail-open), then serde deserialization will fail (hook_event_name expects EventType enum, not integer)
- Assert exit code is not 0 (deserialization error) and not 2 (not a policy block)

**Test 8: `test_event_processing_completes_within_100ms` (REQ-PERF-01)**
- Pipe a valid event JSON to the rulez binary via stdin (same as Test 3)
- Measure wall-clock time using `std::time::Instant::now()` before spawning the process and `elapsed()` after it completes
- Assert elapsed time is < 100ms (this is generous; actual should be <10ms for event processing, but includes process spawn overhead)
- This covers the REQ-PERF-01 requirement ("Total event processing latency remains <10ms p95") with a conservative wall-clock assertion that accounts for process startup
- Note: This is a practical performance regression test. Detailed criterion benchmarks (mentioned in roadmap Key Deliverables) are deferred to a future phase since they add significant build complexity for marginal value at this stage.

Follow existing test patterns:
- Use `Command::cargo_bin("rulez").unwrap()` for the binary
- Use `.write_stdin(json_string)` to pipe stdin
- Use `.current_dir(temp_dir.path())` or set env vars for config resolution
- Use `.assert().code(expected_code)` for exit code checks
- Use `.assert().stderr(predicate)` for error message checks
  </action>
  <verify>
Run `cargo test --tests -p rulez -- schema_validation` to verify all integration tests pass.
Run the full test suite: `cargo test --tests --all-features --workspace` to ensure no regressions.
Run `cargo clippy --all-targets --all-features --workspace -- -D warnings` for lint check.
Run `cargo fmt --all --check` for formatting.
  </verify>
  <done>
- 8 integration tests in schema_validation_integration.rs
- Tests cover: malformed JSON (exit 1), empty stdin (exit 1), valid event (exit 0), missing required fields fails deserialization (not fail-open -- accurately named), extra fields accepted, wrong types fails deserialization, binary size check (REQ-PERF-02), processing time within 100ms (REQ-PERF-01)
- Test 4 is accurately named test_missing_required_fields_fails_deserialization (not the contradictory old name)
- Test 8 covers REQ-PERF-01 with a wall-clock timing assertion
- All existing tests still pass (no regressions)
- Clippy and fmt pass
  </done>
</task>

</tasks>

<verification>
1. `cargo test --lib -p rulez -- schema` passes (unit tests including draft version test)
2. `cargo test --tests -p rulez -- schema_validation` passes (integration tests including performance)
3. `cargo test --tests --all-features --workspace` passes (full suite, no regressions)
4. `cargo clippy --all-targets --all-features --workspace -- -D warnings` clean
5. `cargo fmt --all --check` clean
6. `cargo llvm-cov --all-features --workspace --no-report` passes (coverage run catches pipe/process bugs)
</verification>

<success_criteria>
- 8 unit tests verify schema generation, fail-open validation, and draft version 2020-12 (REQ-SCHEMA-06)
- 8 integration tests verify CLI behavior for all JSON scenarios, performance (REQ-PERF-01), and binary size (REQ-PERF-02)
- Test names accurately reflect behavior (no contradictions between name and assertion)
- Fail-open vs fail-closed distinction is clear: schema validation warns, serde deserialization failures are fatal
- Performance test asserts event processing completes within 100ms wall clock
- Binary size check test exists (ignored by default, requires release build)
- All 605+ existing tests pass with no regressions
- Full CI pipeline passes locally (fmt, clippy, test, coverage)
</success_criteria>

<output>
After completion, create `.planning/phases/07-json-schema-validation/07-02-SUMMARY.md`
</output>
