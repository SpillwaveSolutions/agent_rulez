---
phase: 24-gemini-cli-e2e-testing
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - e2e/scenarios/gemini/01-install.sh
  - e2e/scenarios/gemini/02-hook-fire.sh
  - e2e/scenarios/gemini/03-deny.sh
  - e2e/scenarios/gemini/04-inject.sh
autonomous: true

must_haves:
  truths:
    - "Install scenario creates valid .gemini/settings.json via rulez gemini install"
    - "Hook-fire scenario proves BeforeTool hook fires by asserting audit log entry"
    - "Deny scenario proves deny rule blocks tool call by asserting audit log contains block"
    - "Inject scenario proves inject_command runs by asserting marker file exists"
    - "Scenarios 02-04 skip gracefully (exit 77) when gemini CLI unavailable"
  artifacts:
    - path: "e2e/scenarios/gemini/01-install.sh"
      provides: "Install scenario (structural, no gemini CLI needed)"
      contains: "scenario_install"
    - path: "e2e/scenarios/gemini/02-hook-fire.sh"
      provides: "Hook-fire scenario (requires gemini CLI)"
      contains: "scenario_hook_fire"
    - path: "e2e/scenarios/gemini/03-deny.sh"
      provides: "Deny scenario (requires gemini CLI)"
      contains: "scenario_deny"
    - path: "e2e/scenarios/gemini/04-inject.sh"
      provides: "Inject scenario (requires gemini CLI)"
      contains: "scenario_inject"
  key_links:
    - from: "e2e/scenarios/gemini/01-install.sh"
      to: "rulez gemini install"
      via: "CLI invocation with --scope project --binary flag"
      pattern: "gemini install.*--scope project"
    - from: "e2e/scenarios/gemini/02-hook-fire.sh"
      to: "e2e/lib/gemini_adapter.sh"
      via: "source + invoke_gemini_headless"
      pattern: "invoke_gemini_headless"
    - from: "e2e/scenarios/gemini/02-hook-fire.sh"
      to: "e2e/fixtures/gemini/hooks-hookfire.yaml"
      via: "cp to workspace .claude/hooks.yaml"
      pattern: "fixtures/gemini/hooks-hookfire"
    - from: "e2e/scenarios/gemini/03-deny.sh"
      to: "e2e/fixtures/gemini/hooks-deny.yaml"
      via: "cp to workspace .claude/hooks.yaml"
      pattern: "fixtures/gemini/hooks-deny"
    - from: "e2e/scenarios/gemini/04-inject.sh"
      to: "e2e/fixtures/gemini/hooks-inject.yaml.template"
      via: "sed template substitution to workspace .claude/hooks.yaml"
      pattern: "fixtures/gemini/hooks-inject"
---

<objective>
Create all 4 Gemini E2E scenario scripts that test install, hook-fire, deny, and inject behaviors.

Purpose: These are the actual test scenarios that validate RuleZ works correctly with Gemini CLI. They mirror the Claude Code scenarios but use gemini_adapter.sh functions and the `rulez gemini` subcommands.

Output: 4 scenario scripts in e2e/scenarios/gemini/
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-gemini-cli-e2e-testing/24-RESEARCH.md
@.planning/phases/24-gemini-cli-e2e-testing/24-01-SUMMARY.md

# Pattern references -- follow these structures exactly
@e2e/scenarios/claude-code/01-install.sh
@e2e/scenarios/claude-code/02-hook-fire.sh
@e2e/scenarios/claude-code/03-deny.sh
@e2e/scenarios/claude-code/04-inject.sh
@e2e/lib/gemini_adapter.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install and hook-fire scenarios</name>
  <files>
    e2e/scenarios/gemini/01-install.sh
    e2e/scenarios/gemini/02-hook-fire.sh
  </files>
  <action>
Create `e2e/scenarios/gemini/01-install.sh`:
- Source `gemini_adapter.sh` from `${E2E_ROOT}/lib/gemini_adapter.sh`
- Define `scenario_install(workspace, rulez_binary)` function
- Does NOT call `require_gemini_cli` (install is structural only, no gemini CLI needed)
- Run: `cd "${workspace}" && "${rulez_binary}" gemini install --scope project --binary "${rulez_binary}" 2>&1`
- Assert exit code 0
- Assert `${workspace}/.gemini/settings.json` exists
- Assert settings.json contains `"BeforeTool"` (not PreToolUse -- Gemini uses BeforeTool)
- Assert settings.json contains `"command"`
- Return 0 if all pass, 1 if any fail

Create `e2e/scenarios/gemini/02-hook-fire.sh`:
- Source `gemini_adapter.sh`
- Define `scenario_hook_fire(workspace, rulez_binary)` function
- Call `require_gemini_cli || return $?` first (returns 77 if gemini unavailable)
- Call `setup_gemini_hooks "${workspace}" "${rulez_binary}"` to write .gemini/settings.json
- Copy `${E2E_ROOT}/fixtures/gemini/hooks-hookfire.yaml` to `${workspace}/.claude/hooks.yaml`
  IMPORTANT: RuleZ config (hooks.yaml) always lives at `.claude/hooks.yaml` even for gemini tests.
  The `.gemini/settings.json` tells gemini CLI to call `rulez gemini hook`, and rulez reads its config from `.claude/hooks.yaml`.
- Refresh WORKSPACE_LOG_SNAPSHOT after setup (same pattern as claude-code/02-hook-fire.sh)
- Invoke: `invoke_gemini_headless "${workspace}" "Run this bash command: echo hello-e2e-hookfire" 120 || true`
- Assert: `assert_log_contains "e2e-hookfire-log" "audit log contains hookfire rule name"`
- Return 0/1 based on failures

Both scripts must use `#!/usr/bin/env bash` shebang, bash 3.2 compatible. Match comment style of claude-code scenarios. Make scripts executable (chmod +x).
  </action>
  <verify>
    Run: `bash -n e2e/scenarios/gemini/01-install.sh` (syntax check)
    Run: `bash -n e2e/scenarios/gemini/02-hook-fire.sh` (syntax check)
    Run: `grep 'scenario_install' e2e/scenarios/gemini/01-install.sh` (function defined)
    Run: `grep 'scenario_hook_fire' e2e/scenarios/gemini/02-hook-fire.sh` (function defined)
    Run: `grep 'BeforeTool' e2e/scenarios/gemini/01-install.sh` (asserts gemini hook name)
    Run: `grep 'require_gemini_cli' e2e/scenarios/gemini/02-hook-fire.sh` (skip gate present)
    Run: `grep '.claude/hooks.yaml' e2e/scenarios/gemini/02-hook-fire.sh` (RuleZ config in right place)
  </verify>
  <done>
    01-install.sh tests `rulez gemini install` structurally (no gemini CLI needed). 02-hook-fire.sh tests hook fires with gemini CLI headless invocation, skipping if gemini unavailable. Both pass bash syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deny and inject scenarios</name>
  <files>
    e2e/scenarios/gemini/03-deny.sh
    e2e/scenarios/gemini/04-inject.sh
  </files>
  <action>
Create `e2e/scenarios/gemini/03-deny.sh`:
- Source `gemini_adapter.sh`
- Define `scenario_deny(workspace, rulez_binary)` function
- Call `require_gemini_cli || return $?`
- Call `setup_gemini_hooks "${workspace}" "${rulez_binary}"`
- Copy `${E2E_ROOT}/fixtures/gemini/hooks-deny.yaml` to `${workspace}/.claude/hooks.yaml`
- Refresh WORKSPACE_LOG_SNAPSHOT after setup
- Invoke: `invoke_gemini_headless "${workspace}" "Run this exact bash command: git push --force origin main" 120 || true`
  (don't fail on non-zero exit -- deny IS the expected outcome)
- Assert: `assert_log_contains "e2e-deny-force-push" "audit log contains deny rule name"`
- Assert: `assert_log_contains "block" "audit log contains block action"`
- Return 0/1

Create `e2e/scenarios/gemini/04-inject.sh`:
- Source `gemini_adapter.sh`
- Define `scenario_inject(workspace, rulez_binary)` function
- Call `require_gemini_cli || return $?`
- Call `setup_gemini_hooks "${workspace}" "${rulez_binary}"`
- Use sed to substitute `__WORKSPACE__` in `${E2E_ROOT}/fixtures/gemini/hooks-inject.yaml.template` and write to `${workspace}/.claude/hooks.yaml`
- Refresh WORKSPACE_LOG_SNAPSHOT after setup
- Invoke: `invoke_gemini_headless "${workspace}" "Run this bash command: echo hello-e2e-inject" 120 || true`
- Assert: `assert_file_exists "${workspace}/e2e-inject-fired.marker" "inject marker file created"`
- Assert: `assert_log_contains "e2e-inject-marker" "audit log contains inject rule name"`
- Return 0/1

Both scripts: `#!/usr/bin/env bash`, bash 3.2 compatible, comment style matching claude-code counterparts, chmod +x.

NOTE on .claude/hooks.yaml: Even though these are gemini scenarios, RuleZ policy config (hooks.yaml) is always at `.claude/hooks.yaml` in the workspace. The `.gemini/settings.json` just tells gemini CLI to invoke `rulez gemini hook`, and rulez finds its config from `.claude/hooks.yaml`.
  </action>
  <verify>
    Run: `bash -n e2e/scenarios/gemini/03-deny.sh` (syntax check)
    Run: `bash -n e2e/scenarios/gemini/04-inject.sh` (syntax check)
    Run: `grep 'scenario_deny' e2e/scenarios/gemini/03-deny.sh` (function defined)
    Run: `grep 'scenario_inject' e2e/scenarios/gemini/04-inject.sh` (function defined)
    Run: `grep 'require_gemini_cli' e2e/scenarios/gemini/03-deny.sh` (skip gate)
    Run: `grep 'require_gemini_cli' e2e/scenarios/gemini/04-inject.sh` (skip gate)
    Run: `grep '.claude/hooks.yaml' e2e/scenarios/gemini/03-deny.sh` (RuleZ config path)
    Run: `grep '__WORKSPACE__' e2e/scenarios/gemini/04-inject.sh` (template substitution)
    Verify all 4 scenario files exist: `ls e2e/scenarios/gemini/*.sh | wc -l` returns 4
  </verify>
  <done>
    03-deny.sh tests deny rule blocks gemini tool calls. 04-inject.sh tests inject_command creates marker file. Both skip gracefully when gemini CLI unavailable. All 4 gemini scenarios exist, pass syntax check, and follow the established pattern from claude-code scenarios.
  </done>
</task>

</tasks>

<verification>
- All 4 scenario scripts pass `bash -n` syntax check
- Each script defines the expected function (scenario_install, scenario_hook_fire, scenario_deny, scenario_inject)
- Scenarios 02-04 call `require_gemini_cli` for graceful skip
- Scenario 01 does NOT require gemini CLI (structural only)
- All scenarios source gemini_adapter.sh
- Fixture references point to `e2e/fixtures/gemini/` (not claude-code)
- RuleZ config written to `.claude/hooks.yaml` (not `.gemini/hooks.yaml`)
- Gemini hook config written to `.gemini/settings.json` via setup_gemini_hooks
- run.sh can discover all 4 scenarios via `e2e/scenarios/gemini/*.sh` glob
</verification>

<success_criteria>
- Running `./e2e/run.sh --cli gemini` discovers all 4 scenarios
- 01-install passes (structural, no gemini CLI needed) if rulez binary exists
- 02-04 skip with exit 77 when GEMINI_CLI_AVAILABLE=0
- 02-04 execute and assert against audit log when gemini CLI is available
- No changes to existing claude-code scenarios or harness framework
</success_criteria>

<output>
After completion, create `.planning/phases/24-gemini-cli-e2e-testing/24-02-SUMMARY.md`
</output>
