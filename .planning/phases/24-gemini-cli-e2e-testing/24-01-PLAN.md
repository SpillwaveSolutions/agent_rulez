---
phase: 24-gemini-cli-e2e-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/lib/gemini_adapter.sh
  - e2e/fixtures/gemini/hooks-hookfire.yaml
  - e2e/fixtures/gemini/hooks-deny.yaml
  - e2e/fixtures/gemini/hooks-inject.yaml.template
  - e2e/run.sh
autonomous: true
user_setup:
  - service: gemini-cli
    why: "Gemini CLI required for headless E2E scenarios (02-04)"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API key (https://aistudio.google.com/apikey)"
    dashboard_config:
      - task: "Install Gemini CLI globally"
        location: "npm install -g @google/gemini-cli"

must_haves:
  truths:
    - "gemini_adapter.sh provides check, require, setup_hooks, and invoke_headless functions"
    - "run.sh sources gemini_adapter.sh and checks gemini CLI availability for gemini scenarios"
    - "Gemini fixtures use canonical tool names identical to claude-code fixtures"
  artifacts:
    - path: "e2e/lib/gemini_adapter.sh"
      provides: "Gemini CLI adapter functions"
      exports: ["GEMINI_CLI_NAME", "gemini_adapter_check", "require_gemini_cli", "setup_gemini_hooks", "invoke_gemini_headless"]
    - path: "e2e/fixtures/gemini/hooks-hookfire.yaml"
      provides: "Hookfire test fixture"
      contains: "e2e-hookfire-log"
    - path: "e2e/fixtures/gemini/hooks-deny.yaml"
      provides: "Deny test fixture"
      contains: "e2e-deny-force-push"
    - path: "e2e/fixtures/gemini/hooks-inject.yaml.template"
      provides: "Inject test fixture template"
      contains: "__WORKSPACE__"
    - path: "e2e/run.sh"
      provides: "Updated main entry point with gemini CLI check"
      contains: "gemini_adapter"
  key_links:
    - from: "e2e/run.sh"
      to: "e2e/lib/gemini_adapter.sh"
      via: "source at top-level"
      pattern: "source.*gemini_adapter"
    - from: "e2e/lib/gemini_adapter.sh"
      to: ".gemini/settings.json"
      via: "setup_gemini_hooks writes hook config"
      pattern: "settings\\.json"
---

<objective>
Create the Gemini CLI adapter library, fixture files, and update run.sh to discover and check gemini CLI availability.

Purpose: Establishes all infrastructure needed for Gemini E2E scenarios -- the adapter for headless invocation, hook config setup, fixture YAML rules, and run.sh integration so gemini scenarios are discovered and gemini availability is checked.

Output: gemini_adapter.sh, 3 fixture files, updated run.sh
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-gemini-cli-e2e-testing/24-RESEARCH.md

# Pattern references -- read these to match existing conventions exactly
@e2e/lib/claude_adapter.sh
@e2e/run.sh
@e2e/fixtures/claude-code/hooks-hookfire.yaml
@e2e/fixtures/claude-code/hooks-deny.yaml
@e2e/fixtures/claude-code/hooks-inject.yaml.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gemini_adapter.sh and fixture files</name>
  <files>
    e2e/lib/gemini_adapter.sh
    e2e/fixtures/gemini/hooks-hookfire.yaml
    e2e/fixtures/gemini/hooks-deny.yaml
    e2e/fixtures/gemini/hooks-inject.yaml.template
  </files>
  <action>
Create `e2e/lib/gemini_adapter.sh` as a direct parallel to `e2e/lib/claude_adapter.sh` with these functions:

1. **`GEMINI_CLI_NAME="gemini"` export** at top level (parallel to CLAUDE_CLI_NAME).

2. **`gemini_adapter_check()`** -- checks TWO things:
   - `command -v gemini` exists in PATH (return 1 with error msg if not)
   - `GEMINI_API_KEY` env var is set and non-empty (return 1 with error msg if not)
   - On success, print gemini version via `gemini --version 2>&1 || true` and return 0

3. **`require_gemini_cli()`** -- if `GEMINI_CLI_AVAILABLE` is 1, return 0; otherwise print skip msg to stderr and return 77.

4. **`setup_gemini_hooks(workspace, rulez_binary)`** -- creates `${workspace}/.gemini/settings.json` with a BeforeTool hook:
   - Resolve rulez_binary to absolute path (same pattern as claude_adapter.sh)
   - Hook command: `"${abs_rulez} gemini hook"`
   - Use matcher `".*"` (regex, not glob -- Gemini uses regex matchers)
   - Timeout: 10 seconds
   - Print confirmation message

5. **`invoke_gemini_headless(workspace, prompt, timeout_secs)`** -- default timeout 120:
   - `cd "${workspace}"` then run: `NO_COLOR=true timeout "${timeout_secs}" gemini -p "${prompt}" --yolo --output-format json 2>&1`
   - Pipe through `tee "${workspace}/gemini-output.txt"`
   - Capture exit code via `PIPESTATUS[0]`
   - If exit code is 124 (timeout), print warning and return 77 (treat timeout as skip, not fail -- per research re: --yolo bug)
   - Print exit code and return it

For fixture files, copy the Claude Code fixtures verbatim -- they use canonical tool names (Bash) which work for Gemini after adapter mapping:
- `e2e/fixtures/gemini/hooks-hookfire.yaml` -- identical to `e2e/fixtures/claude-code/hooks-hookfire.yaml`
- `e2e/fixtures/gemini/hooks-deny.yaml` -- identical to `e2e/fixtures/claude-code/hooks-deny.yaml`
- `e2e/fixtures/gemini/hooks-inject.yaml.template` -- identical to `e2e/fixtures/claude-code/hooks-inject.yaml.template`

IMPORTANT: Use `#!/usr/bin/env bash` shebang. Bash 3.2 compatible (no associative arrays, no `declare -A`, no `${var,,}` lowercase syntax). Match the exact comment/header style of claude_adapter.sh.
  </action>
  <verify>
    Run: `bash -n e2e/lib/gemini_adapter.sh` (syntax check passes)
    Run: `diff e2e/fixtures/gemini/hooks-hookfire.yaml e2e/fixtures/claude-code/hooks-hookfire.yaml` (identical)
    Run: `diff e2e/fixtures/gemini/hooks-deny.yaml e2e/fixtures/claude-code/hooks-deny.yaml` (identical)
    Run: `diff e2e/fixtures/gemini/hooks-inject.yaml.template e2e/fixtures/claude-code/hooks-inject.yaml.template` (identical)
    Verify gemini_adapter.sh contains all 5 expected functions: `grep -c 'gemini_adapter_check\|require_gemini_cli\|setup_gemini_hooks\|invoke_gemini_headless\|GEMINI_CLI_NAME' e2e/lib/gemini_adapter.sh` returns 5+
  </verify>
  <done>
    gemini_adapter.sh exists with all 4 functions + 1 exported constant. All 3 fixture files exist and are identical to claude-code counterparts. Bash syntax check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update run.sh to source gemini adapter and check availability</name>
  <files>e2e/run.sh</files>
  <action>
Modify `e2e/run.sh` with two changes:

1. **Add source line at top** (after the existing `source claude_adapter.sh` line):
```bash
# shellcheck source=lib/gemini_adapter.sh
source "${E2E_ROOT}/lib/gemini_adapter.sh"
```

2. **Add gemini CLI check block** inside the `for cli_name in "${CLI_NAMES[@]}"` loop, parallel to the existing `claude-code` block. Add an `elif` (or separate `if`) block right after the claude-code block:
```bash
if [[ "${cli_name}" == "gemini" ]]; then
  if gemini_adapter_check > /dev/null 2>&1; then
    GEMINI_CLI_AVAILABLE=1
  else
    GEMINI_CLI_AVAILABLE=0
    echo "  NOTE: gemini CLI not available â€” scenarios requiring it will be skipped" >&2
  fi
  export GEMINI_CLI_AVAILABLE
fi
```

Do NOT change anything else in run.sh. The dynamic scenario discovery at `e2e/scenarios/gemini/*.sh` will automatically pick up gemini scenarios once the directory exists (Plan 02 creates them).
  </action>
  <verify>
    Run: `bash -n e2e/run.sh` (syntax check passes)
    Run: `grep -c 'gemini_adapter' e2e/run.sh` returns 2+ (source line + check block)
    Run: `grep 'GEMINI_CLI_AVAILABLE' e2e/run.sh` shows the availability flag logic
  </verify>
  <done>
    run.sh sources gemini_adapter.sh at top level and has a gemini CLI availability check block in the CLI loop. Syntax check passes. Existing claude-code functionality unchanged.
  </done>
</task>

</tasks>

<verification>
- `bash -n e2e/lib/gemini_adapter.sh` passes
- `bash -n e2e/run.sh` passes
- All 4 gemini adapter functions are defined
- All 3 fixture files exist in `e2e/fixtures/gemini/`
- run.sh sources gemini_adapter.sh and checks GEMINI_CLI_AVAILABLE
- No changes to existing claude-code files
</verification>

<success_criteria>
- gemini_adapter.sh is a complete parallel of claude_adapter.sh adapted for Gemini CLI
- Fixtures use canonical tool names and are identical to claude-code fixtures
- run.sh integrates gemini adapter without breaking existing claude-code flow
- All bash scripts pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/24-gemini-cli-e2e-testing/24-01-SUMMARY.md`
</output>
