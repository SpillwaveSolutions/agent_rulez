---
phase: 20-gemini-cli-support-and-gemini-hooks-support
plan: 01
type: execute
wave: 1
depends_on:
  - "19-01"
  - "19-02"
  - "19-03"
files_modified:
  - cch_cli/src/adapters/gemini.rs
  - cch_cli/src/models.rs
  - cch_cli/tests/gemini_adapter.rs
autonomous: true

must_haves:
  truths:
    - "Gemini hook events beyond tool hooks map to RuleZ event types without dropping payload data."
    - "Gemini hook responses emit strict JSON with correct decision/continue semantics."
    - "Gemini hook responses can include hook-specific output when RuleZ actions request overrides."
  artifacts:
    - path: "cch_cli/src/adapters/gemini.rs"
      provides: "Gemini event mapping table and response translator"
    - path: "cch_cli/src/models.rs"
      provides: "EventType additions or response structures for Gemini output"
    - path: "cch_cli/tests/gemini_adapter.rs"
      provides: "Fixture coverage for Gemini event mapping and response JSON"
  key_links:
    - from: "cch_cli/src/adapters/gemini.rs"
      to: "cch_cli/src/models.rs"
      via: "EventType mapping and response types"
      pattern: "EventType"
    - from: "cch_cli/tests/gemini_adapter.rs"
      to: "cch_cli/src/adapters/gemini.rs"
      via: "adapter parse/translate fixtures"
      pattern: "Gemini"
---

<objective>
Expand Gemini hook compatibility to cover the full event surface and output semantics so RuleZ decisions behave correctly across tool, agent, model, and lifecycle hooks.

Purpose: Ensure Gemini CLI receives valid decisions and any hook-specific overrides in all hook phases.
Output: Extended Gemini adapter mapping, response types, and fixture tests.
</objective>

<execution_context>
@/Users/richardhightower/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/20-gemini-cli-support-and-gemini-hooks-support/20-RESEARCH.md
@cch_cli/src/models.rs
@cch_cli/src/hooks.rs
@cch_cli/src/adapters/gemini.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand Gemini event mapping and response translation</name>
  <files>cch_cli/src/adapters/gemini.rs, cch_cli/src/models.rs</files>
  <action>
Extend Gemini adapter support to cover the full hook_event_name set (Before/AfterAgent, Before/AfterModel, BeforeToolSelection, SessionStart/End, Notification, PreCompact). Update EventType (or add Gemini-specific variants) so mapping is explicit and preserves the original Gemini event name in tool_input when no direct RuleZ equivalent exists. Add response translation that supports Gemini decision/continue semantics and optional hook-specific output fields (e.g., systemMessage or tool_input overrides) derived from RuleZ response/context.
  </action>
  <verify>cargo test -p cch_cli gemini_adapter</verify>
  <done>Adapter maps all documented Gemini events without panics, and output JSON includes decision/continue with optional hook-specific fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add fixture tests for Gemini mapping and JSON output</name>
  <files>cch_cli/tests/gemini_adapter.rs</files>
  <action>
Create fixture-based tests that parse representative Gemini inputs (tool, agent, model, lifecycle) and assert the resulting RuleZ EventType and normalized tool_input fields. Add output translation tests that verify allow/deny decisions, continue semantics, and hook-specific output fields serialize as strict JSON without extra stdout content.
  </action>
  <verify>cargo test -p cch_cli gemini_adapter</verify>
  <done>Tests cover tool/agent/model/lifecycle event mappings and output JSON for allow/deny with optional overrides.</done>
</task>

</tasks>

<verification>
- `cargo test -p cch_cli gemini_adapter` passes
</verification>

<success_criteria>
- Gemini CLI can invoke RuleZ for any documented hook event and receive valid JSON decisions.
- Gemini hook responses optionally include hook-specific output fields when RuleZ actions request them.
</success_criteria>

<output>
After completion, create `.planning/phases/20-gemini-cli-support-and-gemini-hooks-support/20-01-SUMMARY.md`
</output>
