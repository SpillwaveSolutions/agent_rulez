---
phase: 20-gemini-cli-support-and-gemini-hooks-support
plan: 03
type: execute
wave: 2
depends_on:
  - "20-01"
  - "20-02"
files_modified:
  - cch_cli/src/cli/gemini_hook.rs
  - cch_cli/src/cli.rs
  - cch_cli/src/main.rs
  - cch_cli/tests/gemini_hook_runner.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Gemini hook payloads (e.g., BeforeTool) piped to the CLI are recognized and parsed without falling back to Claude event parsing."
    - "Gemini hook responses emit strict JSON with decision/continue semantics and optional systemMessage/tool_input overrides, with no stdout contamination."
  artifacts:
    - path: "cch_cli/src/cli/gemini_hook.rs"
      provides: "Gemini hook runner entrypoint that reads stdin and emits Gemini JSON"
    - path: "cch_cli/src/main.rs"
      provides: "Gemini hook subcommand wiring"
    - path: "cch_cli/tests/gemini_hook_runner.rs"
      provides: "Runner coverage for BeforeTool payload parsing and JSON output"
  key_links:
    - from: "cch_cli/src/cli/gemini_hook.rs"
      to: "cch_cli/src/adapters/gemini.rs"
      via: "Gemini event parse + response translation"
      pattern: "Gemini"
    - from: "cch_cli/src/main.rs"
      to: "cch_cli/src/cli/gemini_hook.rs"
      via: "Gemini subcommand dispatch"
      pattern: "GeminiSubcommand"
---

<objective>
Provide a dedicated Gemini hook runner entrypoint that accepts Gemini JSON on stdin and emits strict Gemini JSON responses so Gemini CLI can recognize BeforeTool and other hook events.

Purpose: Close the runtime integration gap where Gemini hook payloads are parsed as Claude events and fail to match.
Output: Gemini hook runner subcommand plus coverage for payload parsing and output JSON.
</objective>

<execution_context>
@/Users/richardhightower/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@cch_cli/src/main.rs
@cch_cli/src/cli.rs
@cch_cli/src/adapters/gemini.rs
@cch_cli/src/hooks.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Gemini hook runner subcommand</name>
  <files>cch_cli/src/cli/gemini_hook.rs, cch_cli/src/cli.rs, cch_cli/src/main.rs</files>
  <action>
Create a `cch gemini hook` subcommand that reads stdin, parses Gemini hook JSON with the Gemini adapter, evaluates rules with `hooks::process_event`, and writes a Gemini-compliant JSON response to stdout (decision/continue plus optional systemMessage or tool_input overrides). Ensure stdout contains only JSON (no logs), and use stderr for diagnostics. On parse or evaluation errors, emit a safe Gemini JSON response (decision allow + reason) while still returning exit code 0 to match Gemini hook expectations.
  </action>
  <verify>cargo test -p cch gemini_hook_runner</verify>
  <done>`cch gemini hook` accepts a BeforeTool payload and responds with valid Gemini JSON without mis-parsing as a Claude event.</done>
</task>

<task type="auto">
  <name>Task 2: Add runner tests for Gemini payload parsing and JSON output</name>
  <files>cch_cli/tests/gemini_hook_runner.rs</files>
  <action>
Add integration-style tests that pipe a Gemini BeforeTool payload into the runner and assert the stdout JSON includes a decision field, the original hook_event_name is preserved in tool_input, and stdout is JSON-only. Include a deny-path fixture that verifies decision=deny and a systemMessage/tool_input override when RuleZ context requests it.
  </action>
  <verify>cargo test -p cch gemini_hook_runner</verify>
  <done>Tests cover BeforeTool parsing and strict JSON output (allow/deny) with overrides.</done>
</task>

</tasks>

<verification>
- `cargo test -p cch gemini_hook_runner` passes
</verification>

<success_criteria>
- Gemini CLI hook payloads are parsed through the Gemini adapter and return valid Gemini JSON responses.
- No stdout contamination occurs during hook execution.
</success_criteria>

<output>
After completion, create `.planning/phases/20-gemini-cli-support-and-gemini-hooks-support/20-03-SUMMARY.md`
</output>
